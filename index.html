<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FitPlan Pro ‚ö° | dieta-pronta-teste-2 (v2)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas (Exportar PNG) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Estilo (alto contraste) -->
  <style>
    :root{
      --bg:#0a0f1c; --card:#0b1220; --soft:#111827; --muted:#9ca3af;
      --text:#e5e7eb; --green:#10b981; --green-soft:#86efac; --amber:#f59e0b;
      --border:#374151; --border-strong:#475569; --red:#ef4444;
    }
    html,body{background:var(--bg);color:var(--text)}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.28)}
    .kcal-badge{color:var(--green-soft)}
    .btn{padding:.55rem 1rem;border-radius:.75rem;background:var(--green);color:white;font-weight:700;transition:.15s}
    .btn:hover{filter:brightness(1.08)}
    .btn-ghost{padding:.55rem .95rem;border-radius:.75rem;background:#1f2937;color:#e5e7eb;border:1px solid var(--border);font-weight:700;transition:.15s}
    .btn-ghost:hover{background:#273449;border-color:var(--border-strong)}
    .btn-xs{padding:.35rem .6rem;border-radius:.6rem;font-size:.8rem}
    .btn[disabled]{opacity:.6;filter:saturate(.7);cursor:not-allowed}
    .field{width:100%;padding:.6rem .75rem;border-radius:.75rem;background:#1f2937;color:#e5e7eb;border:1px solid var(--border);outline:none}
    .field:focus{border-color:var(--green);box-shadow:0 0 0 2px rgba(16,185,129,.15)}
    .label{font-size:.8rem;color:#9ca3af}
    .tag{display:inline-flex;align-items:center;border-radius:999px;padding:.15rem .5rem;font-size:.75rem;background:#1f2937;color:#e5e7eb;border:1px solid var(--border);margin-right:.35rem;margin-bottom:.35rem}
    .step{background:#1f2937;color:#cbd5e1;border-radius:.8rem;padding:.55rem 0;text-align:center;border:1px solid var(--border)}
    .step.active{background:#065f46;color:white;border-color:#0ea5a4}
    .divider{height:1px;background:#1f2937;margin:1rem 0}
    .slide{display:none}
    .slide.show{display:block}
    a.link{color:var(--green-soft);text-decoration:underline}
    .pin{filter:grayscale(.2)}
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-5xl mx-auto px-4 pt-8 pb-4">
    <h1 class="text-3xl md:text-4xl font-bold">FitPlan Pro ‚ö°</h1>
    <p class="text-slate-300">Gere sua dieta realista em 5 passos ‚Äî <b>apenas index.html + .json</b>.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 space-y-6 pb-24">
    <!-- STEPPER -->
    <nav class="grid grid-cols-5 gap-2 sticky top-0 z-10">
      <button id="st1" class="step">1</button>
      <button id="st2" class="step">2</button>
      <button id="st3" class="step">3</button>
      <button id="st4" class="step">4</button>
      <button id="st5" class="step">5</button>
    </nav>

    <!-- SLIDE 1: PERFIL -->
    <section id="slide1" class="slide show bg-[color:var(--card)] rounded-2xl p-4 md:p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-3">1) Seu Perfil</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div><div class="label">Sexo</div>
          <select id="sx" class="field">
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
        <div><div class="label">Idade (anos)</div><input id="age" type="number" min="12" max="90" class="field" value="33"/></div>
        <div><div class="label">Altura (cm)</div><input id="h" type="number" min="120" max="220" class="field" value="170"/></div>
        <div><div class="label">Peso (kg)</div><input id="w" type="number" min="35" max="180" class="field" value="73"/></div>
        <div><div class="label">Atividade</div>
          <select id="act" class="field">
            <option value="sedentario">Sedent√°rio</option>
            <option value="leve">Leve (1‚Äì2x/sem)</option>
            <option value="moderada" selected>Moderada (3‚Äì4x/sem)</option>
            <option value="intensa">Intensa (5‚Äì7x/sem)</option>
          </select>
        </div>
        <div><div class="label">Objetivo</div>
          <select id="goal" class="field">
            <option value="cut">Cut (-15%)</option>
            <option value="maint" selected>Manuten√ß√£o</option>
            <option value="bulk">Bulk (+8%)</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="btnCalc" class="btn">Calcular TDEE & Meta</button>
        <button id="btnSaveProfile" class="btn-ghost">Salvar Perfil</button>
      </div>

      <div id="calc-summary" class="mt-4 hidden bg-[#0f172a] rounded-xl p-4 border border-[color:var(--border)]">
        <div class="grid md:grid-cols-3 gap-3">
          <div><div class="label">BMR (Mifflin)</div><div id="bmrOut" class="text-emerald-300 text-xl">‚Äî</div></div>
          <div><div class="label">TDEE</div><div id="tdeeOut" class="text-emerald-300 text-xl">‚Äî</div></div>
          <div><div class="label">Meta di√°ria</div><div id="targetOut" class="text-emerald-300 text-xl">‚Äî</div></div>
        </div>
        <p class="text-slate-400 text-sm mt-2">Dica cardio pessoal: Z2 ‚âà <b>145 bpm</b>.</p>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <button class="btn-ghost" disabled>Voltar</button>
        <button id="next1" class="btn">Pr√≥ximo</button>
      </div>
    </section>

    <!-- SLIDE 2: PRESETS -->
    <section id="slide2" class="slide bg-[color:var(--card)] rounded-2xl p-4 md:p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-3">2) Escolha um modelo (presets el√°sticos)</h2>
      <div id="presetList" class="grid md:grid-cols-2 gap-3"></div>

      <div class="mt-6 flex items-center justify-between">
        <button id="prev2" class="btn-ghost">Voltar</button>
        <button id="next2" class="btn">Pr√≥ximo</button>
      </div>
    </section>

    <!-- SLIDE 3: FILTROS -->
    <section id="slide3" class="slide bg-[color:var(--card)] rounded-2xl p-4 md:p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-3">3) Filtros r√°pidos</h2>
      <div class="flex flex-wrap">
        <label class="tag"><input class="mr-1" type="checkbox" value="pf" /> pf</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="marmita" /> marmita</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="caseiro" /> caseiro</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="r√°pido" /> r√°pido</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="baixo-custo" /> baixo-custo</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="integral" /> integral</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="alto-prote√≠na" /> alto-prote√≠na</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="low-carb" /> low-carb</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="vegetariano" /> vegetariano</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="vegano" /> vegano</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="sem-gluten" /> sem-gluten</label>
        <label class="tag"><input class="mr-1" type="checkbox" value="sem-lactose" /> sem-lactose</label>
      </div>
      <div class="mt-3 flex flex-wrap gap-2 items-center">
        <button id="btnApplyFilters" class="btn-ghost">Aplicar filtros</button>
        <button id="btnClearFilters" class="btn-ghost">Limpar</button>
        <div class="flex items-center gap-2 ml-auto">
          <span class="label">Varia√ß√£o</span>
          <input id="varSlider" type="range" min="0" max="100" value="45" class="w-40"/>
          <span id="varOut" class="text-slate-300 text-sm">45%</span>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <button id="prev3" class="btn-ghost">Voltar</button>
        <button id="next3" class="btn">Pr√≥ximo</button>
      </div>
    </section>

    <!-- SLIDE 4: PLANNER -->
    <section id="slide4" class="slide bg-[color:var(--card)] rounded-2xl p-4 md:p-6 shadow-soft">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <h2 class="text-xl font-semibold">4) Seu Plano Gerado</h2>
        <div class="flex gap-2 flex-wrap">
          <button id="btnRegenDay" class="btn-ghost">Regerar dia</button>
          <button id="btnExportPNG" class="btn">Exportar PNG</button>
          <button id="btnSavePlan" class="btn-ghost">Salvar Plano</button>
          <label class="btn-ghost cursor-pointer">Importar Plano<input id="importPlan" type="file" accept="application/json" class="hidden"/></label>
        </div>
      </div>
      <p class="text-slate-400 text-sm mt-1">Dica: voc√™ pode <b>fixar</b> itens (üìå) para n√£o mudarem ao regerar.</p>
      <div id="planner" class="mt-4 space-y-4"></div>
      <div class="divider"></div>
      <p class="text-slate-400 text-sm">Nota: Prote√≠nas pesadas <b>cruas</b>; Carbos <b>cozidos</b>. Macros por 100 g no estado indicado.</p>
      <div class="mt-6 flex items-center justify-between">
        <button id="prev4" class="btn-ghost">Voltar</button>
        <button id="next4" class="btn">Pr√≥ximo</button>
      </div>
    </section>

    <!-- SLIDE 5: RESUMO/EXPORT -->
    <section id="slide5" class="slide bg-[color:var(--card)] rounded-2xl p-4 md:p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-3">5) Resumo & Exporta√ß√£o</h2>
      <p class="text-slate-300 mb-3">Revise o total di√°rio, fa√ßa trocas se quiser (volte ao passo 4) e <b>exporte</b> seu plano em PNG ou <b>salve</b> o arquivo JSON para recuperar depois.</p>
      <div class="flex gap-2">
        <button id="btnExportPNG2" class="btn">Exportar PNG</button>
        <button id="btnSavePlan2" class="btn-ghost">Salvar Plano</button>
      </div>
      <div class="mt-6 flex items-center justify-between">
        <button id="prev5" class="btn-ghost">Voltar</button>
        <button class="btn" onclick="window.scrollTo({top:0,behavior:'smooth'})">Finalizar ‚Üë</button>
      </div>
    </section>

    <!-- MODAL SWAP -->
    <div id="swapModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
      <div class="bg-[color:var(--card)] rounded-2xl p-4 md:p-6 max-w-2xl w-full shadow-soft border border-[color:var(--border)]">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Trocar alimento</h3>
          <button id="btnCloseSwap" class="btn-ghost">Fechar</button>
        </div>
        <p id="swapHint" class="text-slate-400 text-sm mt-1"></p>
        <div id="swapList" class="mt-3 max-h-[55vh] overflow-auto space-y-2"></div>
      </div>
    </div>
  </main>

  <!-- ================= L√ìGICA ================= -->
  <script>
  // ------- Slides / Stepper -------
  const slides=['slide1','slide2','slide3','slide4','slide5'];
  let currentStep=1;
  function showStep(n){currentStep=Math.min(Math.max(n,1),5);slides.forEach((id,idx)=>{const el=document.getElementById(id);if(!el)return;el.classList.toggle('show', idx===currentStep-1)});[1,2,3,4,5].forEach(i=>document.getElementById('st'+i).classList.toggle('active',i===currentStep));window.scrollTo({top:0,behavior:'smooth'})}
  showStep(1);

  // ------- Estado (localStorage) -------
  const LS_KEYS={profile:'dpt2_profile',prefs:'dpt2_prefs',plan:'dpt2_plan',pins:'dpt2_pins'};
  const AppState={
    saveProfile:p=>localStorage.setItem(LS_KEYS.profile,JSON.stringify(p)),
    loadProfile:()=>{try{return JSON.parse(localStorage.getItem(LS_KEYS.profile)||'null')}catch{return null}},
    savePrefs:p=>localStorage.setItem(LS_KEYS.prefs,JSON.stringify(p)),
    loadPrefs:()=>{try{return JSON.parse(localStorage.getItem(LS_KEYS.prefs)||'{"tags_incluir":[],"tags_evitar":[],"equivalentes_estado":true,"var":45}')}catch{return {tags_incluir:[],tags_evitar:[],equivalentes_estado:true,var:45}}},
    savePlan:p=>localStorage.setItem(LS_KEYS.plan,JSON.stringify(p)),
    loadPlan:()=>{try{return JSON.parse(localStorage.getItem(LS_KEYS.plan)||'null')}catch{return null}},
    savePins:set=>localStorage.setItem(LS_KEYS.pins,JSON.stringify([...set])),
    loadPins:()=>{try{return new Set(JSON.parse(localStorage.getItem(LS_KEYS.pins)||'[]'))}catch{return new Set()}}
  };

  // ------- Dados -------
  const Data={foods:[],presets:[],manifestVersion:0};
  async function loadManifest(){const r=await fetch('data/foods_manifest.json');const j=await r.json();Data.manifestVersion=j.version||1;return j.files||[]}
  async function loadFoods(files){const all=[];for(const f of files){try{const r=await fetch('data/'+f+'?v='+Data.manifestVersion);const j=await r.json();if(Array.isArray(j))all.push(...j)}catch(e){console.warn('Falha ao carregar',f)}}const seen=new Set();Data.foods=all.filter(it=>it&&!seen.has(it.id)&&(seen.add(it.id),true))}
  async function loadPresets(){const r=await fetch('data/presets.json?v='+Data.manifestVersion);const j=await r.json();Data.presets=j.presets||[]}

  // ------- C√°lculo -------
  function bmrMifflin(sexo,peso,alt,idade){return sexo==='M'?(10*peso+6.25*alt-5*idade+5):(10*peso+6.25*alt-5*idade-161)}
  function tdee(bmr,act){const m={sedentario:1.2,leve:1.375,moderada:1.55,intensa:1.725};return bmr*(m[act]||1.55)}
  function targetKcal(tdee,goal){if(goal==='cut')return Math.round(tdee*0.85);if(goal==='bulk')return Math.round(tdee*1.08);return Math.round(tdee)}

  // ------- Variedade (aleatoriedade ponderada + mem√≥ria anti-repeti√ß√£o) -------
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
  function weightedRandom(items,getW){const acc=[];let sum=0;items.forEach(it=>{sum+=Math.max(0.0001,getW(it));acc.push(sum)});const r=Math.random()*sum;const idx=acc.findIndex(x=>x>=r);return items[Math.max(0,idx)]}
  const Memory={last:new Set(), clear(){this.last.clear()}, mark(id){this.last.add(id)}, has(id){return this.last.has(id)}}

  // ------- Caps e metas -------
  const CAPS={solidMin:30,solidMax:250,oilMin:5,oilMax:20};
  function mealTargets(kcal,ratio){const kcalP=kcal*(ratio.P||0),kcalC=kcal*(ratio.C||0),kcalG=kcal*(ratio.G||0);return{kcal:Math.round(kcal),P:+(kcalP/4).toFixed(1),C:+(kcalC/4).toFixed(1),G:+(kcalG/9).toFixed(1)}}

  // ------- Escolha de alimentos (ponderando filtros + varia√ß√£o + anti-repeti√ß√£o) -------
  function pickPoolByFamily(family,prefs,preferState){
    let list=Data.foods.filter(f=>f.family===family);
    if(!list.length) return [];
    const inc=new Set((prefs.tags_incluir||[]).map(x=>x.toLowerCase()));
    const hardExclude=new Set((prefs.tags_evitar||[]).map(x=>x.toLowerCase()));
    list=list.filter(f=>!(f.tags||[]).some(t=>hardExclude.has(String(t).toLowerCase())));

    const varFactor=(+prefs.var||45)/100; // 0‚Äì1
    const score=(f)=>{
      const t=(f.tags||[]).map(s=>String(s).toLowerCase());
      const match=t.filter(x=>inc.has(x)).length;        // afinidade por filtro
      const penal=Memory.has(f.id)?(0.35+0.3*varFactor):0;// penaliza repeti√ß√£o recente
      const same=(preferState && f.state===preferState)?0.25:0; // b√¥nus leve se bater estado
      const fast=(f.prep_min!=null && f.prep_min<=10)?0.15:0;   // b√¥nus "r√°pido" se cadastrado
      const cheap=(t.includes('baixo-custo')?0.1:0);            // b√¥nus baixo custo
      const base=1+0.5*match+same+fast+cheap;
      return Math.max(0.05, base - penal);
    };
    // Embaralha para estabilidade visual e retorna com peso
    list=shuffle(list.slice(0)).map(x=>({...x,__w:score(x)}));
    // Ordena apenas para debug/consist√™ncia (opcional)
    list.sort((a,b)=>b.__w-a.__w);
    return list;
  }

  function gramsForTargets(item,t){
    const p=item.P||0,c=item.C||0,g=item.G||0;
    let basis=p?'P':(c?'C':'G');
    if(t.P>=t.C&&t.P>=t.G&&p)basis='P'; else if(t.C>=t.P&&t.C>=t.G&&c)basis='C'; else if(g)basis='G';
    const per100=(basis==='P'?p:(basis==='C'?c:g));
    if(per100<=0) return 0;
    let grams=(t[basis]/per100)*100;
    if(item.family==='Gordura') grams=Math.min(Math.max(grams,CAPS.oilMin),CAPS.oilMax);
    else grams=Math.min(Math.max(grams,CAPS.solidMin),CAPS.solidMax);
    return Math.round(grams);
  }

  function computeMealKcal(items){
    let kcal=0,P=0,C=0,G=0;
    for(const it of items){const f=Data.foods.find(x=>x.id===it.id); if(!f) continue; const k=(it.g||0)/100; kcal+=(f.kcal||0)*k; P+=(f.P||0)*k; C+=(f.C||0)*k; G+=(f.G||0)*k}
    return {kcal:Math.round(kcal),P:+P.toFixed(1),C:+C.toFixed(1),G:+G.toFixed(1)}
  }

  // ------- Constru√ß√£o do plano com variedade -------
  function buildPlan(meta,preset,prefs){
    const pins=AppState.loadPins();
    const plan={meta_kcal:meta,preset_id:preset.id,meals:[]};
    Memory.clear();
    for(const m of (preset.meals||[])){
      const kcalMeal=meta*(m.kcal_frac||0.25);
      const tgt=mealTargets(kcalMeal, m.macro_ratio||{P:.3,C:.45,G:.25});
      const items=[];
      for(const fam of (m.families||[])){
        const pool=pickPoolByFamily(fam, prefs, null);
        if(!pool.length) continue;
        const chosen=weightedRandom(pool, x=>x.__w||1);
        const grams=gramsForTargets(chosen, tgt);
        const idKey=`${fam}:${chosen.id}`;
        const locked=pins.has(idKey)&&false; // pins guardam item espec√≠fico por fam√≠lia; false na gera√ß√£o inicial
        items.push({id:chosen.id,name:chosen.name,family:fam,state:chosen.state,g:grams,locked:false});
        Memory.mark(chosen.id);
      }
      plan.meals.push({id:m.id,name:m.name,target:tgt,items});
    }
    return plan;
  }

  // Regerar dia (respeitando pins)
  function regenerateDay(plan,preset,prefs){
    Memory.clear();
    for(const m of plan.meals){
      const tgt=m.target; // mant√©m metas
      const newItems=[];
      for(let i=0;i<m.items.length;i++){
        const it=m.items[i];
        if(it.locked){ newItems.push(it); Memory.mark(it.id); continue; }
        const pool=pickPoolByFamily(it.family, prefs, it.state);
        if(!pool.length){ newItems.push(it); continue; }
        const chosen=weightedRandom(pool, x=>x.__w||1);
        const grams=gramsForTargets(chosen, tgt);
        newItems.push({id:chosen.id,name:chosen.name,family:it.family,state:chosen.state,g:grams,locked:false});
        Memory.mark(chosen.id);
      }
      m.items=newItems;
    }
    return plan;
  }

  // Regerar apenas uma refei√ß√£o
  function regenerateMeal(plan,mealIdx,prefs){
    const m=plan.meals[mealIdx];
    Memory.clear();
    const tgt=m.target;
    const newItems=[];
    for(const it of m.items){
      if(it.locked){ newItems.push(it); Memory.mark(it.id); continue; }
      const pool=pickPoolByFamily(it.family, prefs, it.state);
      if(!pool.length){ newItems.push(it); continue; }
      const chosen=weightedRandom(pool, x=>x.__w||1);
      const grams=gramsForTargets(chosen, tgt);
      newItems.push({id:chosen.id,name:chosen.name,family:it.family,state:chosen.state,g:grams,locked:false});
      Memory.mark(chosen.id);
    }
    m.items=newItems;
    return plan;
  }

  // ------- Render -------
  function renderPresets(){
    const wrap=document.getElementById('presetList'); wrap.innerHTML='';
    Data.presets.forEach(p=>{
      const meals=(p.meals||[]).map(m=>m.name).join(' ¬∑ ');
      const el=document.createElement('div');
      el.className='bg-[#0f172a] border border-[color:var(--border)] rounded-xl p-4';
      el.innerHTML=`<div class="flex items-start justify-between gap-3">
        <div><div class="font-semibold">${p.name}</div>
        <div class="text-slate-400 text-sm">${meals}</div></div>
        <button class="btn" data-pid="${p.id}">Selecionar</button></div>`;
      wrap.appendChild(el);
    });
    wrap.querySelectorAll('button[data-pid]').forEach(b=>b.addEventListener('click',()=>{
      const p=Data.presets.find(x=>x.id===b.dataset.pid);
      const profile=readProfileUI();
      const bmr=bmrMifflin(profile.sexo,profile.peso_kg,profile.altura_cm,profile.idade);
      const td=tdee(bmr,profile.atividade);
      const meta=targetKcal(td,profile.objetivo);
      showCalc(bmr,td,meta);
      const prefs=AppState.loadPrefs();
      const plan=buildPlan(meta,p,prefs);
      AppState.savePlan(plan);
      renderPlanner(plan);
      showStep(4);
    }));
  }

  function pctDev(v,t){if(!t)return 0;return Math.round(((v-t)/t)*100)}
  function devBadge(p){return (Math.abs(p)<=2?'¬±2%':(p>0?('+'+p+'%'):(p+'%')))}

  function renderPlanner(plan){
    const host=document.getElementById('planner'); host.innerHTML='';
    if(!plan||!plan.meals) return;

    // Totais
    const total=plan.meals.reduce((a,m)=>{const s=computeMealKcal(m.items);a.kcal+=s.kcal;a.P+=s.P;a.C+=s.C;a.G+=s.G;return a},{kcal:0,P:0,C:0,G:0});
    const meta=plan.meta_kcal; const tol=Math.abs(total.kcal-meta)/meta;
    const tolBadge=tol<=0.02?`<span class="text-emerald-400">üü¢ dentro do alvo (¬±2%)</span>`:`<span class="text-amber-300">üü† fora do alvo (${Math.round(tol*100)}%)</span>`;
    const head=document.createElement('div'); head.className='bg-[#0f172a] rounded-xl p-3 flex items-center justify-between border border-[color:var(--border)] flex-wrap gap-2';
    head.innerHTML=`<div class="text-sm md:text-base">Meta: <b>${meta}</b> kcal ¬∑ Total: <b>${total.kcal}</b> kcal <span class="ml-2">${tolBadge}</span></div>
                    <div class="text-slate-400 text-sm">P:${total.P.toFixed(0)}g ¬∑ C:${total.C.toFixed(0)}g ¬∑ G:${total.G.toFixed(0)}g</div>`;
    host.appendChild(head);

    // Refei√ß√µes
    plan.meals.forEach((m,mi)=>{
      const sum=computeMealKcal(m.items);
      const row=document.createElement('div'); row.className='bg-[#0f172a] rounded-xl p-4 border border-[color:var(--border)]';
      const devP=pctDev(sum.P,m.target.P),devC=pctDev(sum.C,m.target.C),devG=pctDev(sum.G,m.target.G);
      row.innerHTML=`
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-semibold">${m.name}</div>
          <div class="flex items-center gap-2">
            <button class="btn-ghost btn-xs" data-regmi="${mi}">Regerar refei√ß√£o</button>
            <div class="kcal-badge font-semibold">${sum.kcal} kcal</div>
          </div>
        </div>
        <div class="text-slate-400 text-sm mt-1">
          Alvo: P ${m.target.P}g (${devBadge(devP)}) ¬∑ C ${m.target.C}g (${devBadge(devC)}) ¬∑ G ${m.target.G}g (${devBadge(devG)})
        </div>
        <div class="mt-3 space-y-2">
          ${m.items.map((it,ii)=>{
            const f=Data.foods.find(x=>x.id===it.id)||{};
            const pin=it.locked?"üìå":"üìç";
            return `
            <div class="flex items-center justify-between bg-[#111827] rounded-lg p-2 border border-[color:var(--border)]">
              <div>
                <div class="font-medium">${f.name||it.name}</div>
                <div class="text-slate-400 text-xs">Fam√≠lia: ${it.family} ¬∑ Estado: ${it.state||'-'}</div>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn-ghost btn-xs" title="Fixar/soltar" data-pin="${mi}:${ii}">${pin}</button>
                <div class="text-sm w-20 text-right">${it.g} g</div>
                <button class="btn-ghost btn-xs" data-swap="${mi}:${ii}">Trocar</button>
              </div>
            </div>`;
          }).join('')}
        </div>`;
      host.appendChild(row);
    });

    // Binds dos bot√µes por refei√ß√£o
    host.querySelectorAll('button[data-swap]').forEach(b=>b.addEventListener('click',()=>{const [mi,ii]=b.dataset.swap.split(':').map(Number);openSwap(AppState.loadPlan(),mi,ii)}));
    host.querySelectorAll('button[data-pin]').forEach(b=>b.addEventListener('click',()=>{const [mi,ii]=b.dataset.pin.split(':').map(Number);togglePin(mi,ii)}));
    host.querySelectorAll('button[data-regmi]').forEach(b=>b.addEventListener('click',()=>{const mi=+b.dataset.regmi; const plan=AppState.loadPlan(); const prefs=AppState.loadPrefs(); regenerateMeal(plan,mi,prefs); AppState.savePlan(plan); renderPlanner(plan)}));
  }

  function showCalc(bmr,tdeeVal,meta){
    document.getElementById('calc-summary').classList.remove('hidden');
    document.getElementById('bmrOut').textContent=Math.round(bmr);
    document.getElementById('tdeeOut').textContent=Math.round(tdeeVal);
    document.getElementById('targetOut').textContent=meta;
  }

  // ------- Pins (fixar itens) -------
  function togglePin(mi,ii){
    const plan=AppState.loadPlan();
    const it=plan.meals[mi].items[ii];
    it.locked=!it.locked;
    AppState.savePlan(plan);
    renderPlanner(plan);
  }

  // ------- SWAP (gramatura manual) -------
  let SWAP_CTX=null;
  function openSwap(plan,mealIdx,itemIdx){
    SWAP_CTX={plan,mealIdx,itemIdx};
    const m=plan.meals[mealIdx]; const it=m.items[itemIdx];
    document.getElementById('swapHint').innerHTML=`Equivalentes para fam√≠lia <b>${it.family}</b> (prioriza mesmo estado: <b>${it.state||'-'}</b>).`;
    const prefs=AppState.loadPrefs();
    const list=pickPoolByFamily(it.family,prefs,it.state);

    const box=document.getElementById('swapList'); box.innerHTML='';
    list.slice(0,120).forEach(f=>{
      const el=document.createElement('div'); el.className='bg-[#111827] border border-[color:var(--border)] rounded-lg p-2';
      const id=`g_${f.id}`;
      el.innerHTML=`
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-medium">${f.name}</div>
            <div class="text-slate-400 text-xs">Estado: ${f.state||'-'} ¬∑ 100 g ‚Üí P ${f.P||0}g ¬∑ C ${f.C||0}g ¬∑ G ${f.G||0}g</div>
          </div>
          <div class="flex items-center gap-2">
            <input id="${id}" type="number" min="1" max="1000" placeholder="g" class="field w-28" />
            <button class="btn-ghost btn-xs" data-use="${f.id}">Usar</button>
            <button class="btn btn-xs" data-useg="${f.id}">Usar c/gramas</button>
          </div>
        </div>`;
      box.appendChild(el);
    });

    document.getElementById('swapModal').classList.remove('hidden');
    box.querySelectorAll('button[data-use]').forEach(b=>b.addEventListener('click',()=>applySwap(+b.dataset.use,null)));
    box.querySelectorAll('button[data-useg]').forEach(b=>b.addEventListener('click',()=>{const fid=+b.dataset.useg; const g=document.getElementById('g_'+fid).value; applySwap(fid, g?+g:null)}));
  }
  function applySwap(foodId, gramsManual){
    if(!SWAP_CTX) return;
    const {plan,mealIdx,itemIdx}=SWAP_CTX;
    const m=plan.meals[mealIdx]; const tgt=m.target;
    const chosen=Data.foods.find(f=>f.id===foodId); if(!chosen) return;

    let grams=gramsManual;
    if(!grams||grams<=0){
      const others=m.items.filter((_,i)=>i!==itemIdx);
      const partial=computeMealKcal(others);
      const remaining={kcal:Math.max(tgt.kcal-partial.kcal,0),P:Math.max(tgt.P-partial.P,0),C:Math.max(tgt.C-partial.C,0),G:Math.max(tgt.G-partial.G,0)};
      grams=gramsForTargets(chosen,remaining);
    }
    if(chosen.family==='Gordura'){grams=Math.min(Math.max(grams,CAPS.oilMin),CAPS.oilMax)}
    else {grams=Math.min(Math.max(grams,CAPS.solidMin),CAPS.solidMax)}

    m.items[itemIdx]={id:chosen.id,name:chosen.name,family:chosen.family,state:chosen.state,g:Math.round(grams),locked:false};
    AppState.savePlan(plan); renderPlanner(plan); closeSwap();
  }
  function closeSwap(){document.getElementById('swapModal').classList.add('hidden'); SWAP_CTX=null}

  // ------- Utilit√°rios -------
  function readProfileUI(){return{sexo:document.getElementById('sx').value,idade:+document.getElementById('age').value,altura_cm:+document.getElementById('h').value,peso_kg:+document.getElementById('w').value,atividade:document.getElementById('act').value,objetivo:document.getElementById('goal').value}}
  function gatherFilters(){const boxes=document.querySelectorAll('#slide3 input[type=checkbox]');const inc=[];boxes.forEach(b=>b.checked&&inc.push(b.value)); const prefs=AppState.loadPrefs(); return{tags_incluir:inc,tags_evitar:prefs.tags_evitar||[],equivalentes_estado:true,var:prefs.var||45}}
  async function exportPNG(){const el=document.getElementById('slide4');const canvas=await html2canvas(el,{backgroundColor:'#0a0f1c',scale:2,useCORS:true});const url=canvas.toDataURL('image/png');const a=document.createElement('a');a.href=url;a.download='FitPlan_'+new Date().toISOString().slice(0,10)+'.png';a.click()}

  // ------- Binds: navega√ß√£o & a√ß√µes -------
  ;[1,2,3,4,5].forEach(i=>document.getElementById('st'+i).addEventListener('click',()=>showStep(i)));
  document.getElementById('next1').addEventListener('click',()=>showStep(2));
  document.getElementById('prev2').addEventListener('click',()=>showStep(1));
  document.getElementById('next2').addEventListener('click',()=>showStep(3));
  document.getElementById('prev3').addEventListener('click',()=>showStep(2));
  document.getElementById('next3').addEventListener('click',()=>showStep(4));
  document.getElementById('prev4').addEventListener('click',()=>showStep(3));
  document.getElementById('next4').addEventListener('click',()=>showStep(5));
  document.getElementById('prev5').addEventListener('click',()=>showStep(4));

  document.getElementById('btnCalc').addEventListener('click',()=>{const p=readProfileUI();const b=bmrMifflin(p.sexo,p.peso_kg,p.altura_cm,p.idade);const td=tdee(b,p.atividade);const meta=targetKcal(td,p.objetivo);showCalc(b,td,meta)});
  document.getElementById('btnSaveProfile').addEventListener('click',()=>{AppState.saveProfile(readProfileUI())});

  document.getElementById('btnApplyFilters').addEventListener('click',()=>{const prefs=gatherFilters();AppState.savePrefs(prefs);const plan=AppState.loadPlan();if(plan)renderPlanner(plan)});
  document.getElementById('btnClearFilters').addEventListener('click',()=>{document.querySelectorAll('#slide3 input[type=checkbox]').forEach(b=>b.checked=false);const prefs=AppState.loadPrefs();prefs.tags_incluir=[];AppState.savePrefs(prefs);const plan=AppState.loadPlan();if(plan)renderPlanner(plan)});
  document.getElementById('varSlider').addEventListener('input',e=>{const v=+e.target.value;document.getElementById('varOut').textContent=v+'%';const prefs=AppState.loadPrefs();prefs.var=v;AppState.savePrefs(prefs)});

  document.getElementById('btnExportPNG').addEventListener('click',exportPNG);
  document.getElementById('btnSavePlan').addEventListener('click',()=>{const plan=AppState.loadPlan(); if(!plan) return; const blob=new Blob([JSON.stringify(plan,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='meu_plano.json'; a.click(); URL.revokeObjectURL(url)});
  document.getElementById('btnExportPNG2').addEventListener('click',exportPNG);
  document.getElementById('btnSavePlan2').addEventListener('click',()=>document.getElementById('btnSavePlan').click());
  document.getElementById('importPlan').addEventListener('change',e=>{if(!e.target.files[0])return; const fr=new FileReader(); fr.onload=()=>{try{const obj=JSON.parse(fr.result);AppState.savePlan(obj);renderPlanner(obj);showStep(4)}catch{alert('Arquivo inv√°lido')}}; fr.readAsText(e.target.files[0])});
  document.getElementById('btnCloseSwap').addEventListener('click',closeSwap);

  document.getElementById('btnRegenDay').addEventListener('click',()=>{const plan=AppState.loadPlan(); if(!plan) return; const prefs=AppState.loadPrefs(); const preset=Data.presets.find(p=>p.id===plan.preset_id) || Data.presets[0]; regenerateDay(plan,preset,prefs); AppState.savePlan(plan); renderPlanner(plan)});

  // ------- Boot -------
  (async function boot(){
    const prof=AppState.loadProfile(); if(prof){
      document.getElementById('sx').value=prof.sexo; document.getElementById('age').value=prof.idade;
      document.getElementById('h').value=prof.altura_cm; document.getElementById('w').value=prof.peso_kg;
      document.getElementById('act').value=prof.atividade; document.getElementById('goal').value=prof.objetivo;
    }
    const files=await loadManifest(); await loadFoods(files); await loadPresets(); renderPresets();
    const plan=AppState.loadPlan(); if(plan){renderPlanner(plan); showStep(4)}
  })();
  </script>
</body>
</html>
