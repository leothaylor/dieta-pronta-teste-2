<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitPlan Pro - Gerador de Dieta Inteligente</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o de fontes e cores do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e293b',
                        'secondary-dark': '#0f172a',
                        'accent': '#4ade80', // Verde vibrante
                        'accent-light': '#86efad',
                        'text-light': '#f8fafc',
                        'text-muted': '#94a3b8',
                        'danger': '#ef4444', // Vermelho para avisos
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Carrega bibliotecas para Exporta√ß√£o (PNG/PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #0f172a; /* secondary-dark */
            color: #f8fafc; /* text-light */
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1e293b; /* primary-dark */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid #334155;
        }
        .stepper-active {
            background-color: #4ade80;
            color: #0f172a;
            font-weight: 700;
        }
        .stepper-done {
            background-color: #334155;
            color: #f8fafc;
        }
        .input-dark, select.input-dark {
            background-color: #0f172a;
            border-color: #334155;
            color: #f8fafc;
        }
        .tab-active {
            border-bottom: 3px solid #4ade80;
            color: #4ade80;
            font-weight: 600;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #94a3b8;
            margin-left: 4px;
        }
        .loading-spinner {
            border: 4px solid rgba(248, 250, 252, 0.1);
            border-top: 4px solid #4ade80;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- T√≠tulo e Introdu√ß√£o -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-accent">FitPlan Pro ‚ö°</h1>
            <p class="text-text-muted mt-1">Gere sua dieta realista em 5 passos.</p>
        </header>

        <!-- Stepper (Navega√ß√£o) -->
        <div id="stepper" class="flex justify-between items-center mb-8 bg-primary-dark p-3 rounded-xl shadow-lg">
            <!-- Os passos ser√£o renderizados pelo JS -->
        </div>

        <!-- Conte√∫do Principal (Formul√°rio ou Plano) -->
        <main id="app-content">
            <!-- O conte√∫do ser√° renderizado pelo JS -->
        </main>

        <!-- Se√ß√£o de Mensagens (para feedback e erros) -->
        <div id="message-area" class="mt-4 p-3 rounded-lg text-center hidden"></div>
    </div>

    <!-- Modal de Mensagem (Troca Invi√°vel, Sucesso, etc.) -->
    <div id="app-modal" class="fixed inset-0 bg-secondary-dark bg-opacity-80 hidden items-center justify-center z-50">
        <div class="card w-full max-w-sm mx-4 p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-accent"></h3>
            <p id="modal-content" class="text-text-light mb-5"></p>
            <button onclick="hideModal()" class="w-full bg-accent text-secondary-dark font-bold py-2 px-4 rounded-lg hover:bg-accent-light transition duration-200">
                Entendi
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-secondary-dark bg-opacity-90 hidden flex-col items-center justify-center z-50">
        <div class="loading-spinner"></div>
        <p id="loading-message" class="text-text-light mt-4 text-lg font-medium">Processando dados...</p>
    </div>

    <!-- Scripts do Aplicativo -->
    <script>
        // Vari√°veis Globais de Configura√ß√£o
        const APP_ID = 'fitplan-pro-v1';
        const STEPS = [
            { name: "Objetivo", key: 'goal' },
            { name: "Dados F√≠sicos", key: 'body' },
            { name: "Rotina/Treino", key: 'routine' },
            { name: "Prefer√™ncias", key: 'prefs' },
            { name: "Dispensa (Opcional)", key: 'pantry' },
        ];

        // Mapeamento de Fatores
        const TDEE_MULTIPLIERS = {
            'sedentario': 1.2, 'leve': 1.375, 'moderado': 1.55, 'ativo': 1.725, 'atleta': 1.9,
        };
        const BUDGET_MAP = { 'baixo': 1, 'medio': 2, 'alto': 3 };
        const TIME_MAP = { 'lt_15': 1, '15_30': 2, 'gt_30': 3 };

        // Regras de Distribui√ß√£o Cal√≥rica (4 Refei√ß√µes Padr√£o)
        const CALORIE_DISTRIBUTION_BASE = [
            { name: 'Caf√© da Manh√£', basePct: 25, type: 'pre-morning' },
            { name: 'Almo√ßo', basePct: 35, type: 'mid-day' },
            { name: 'Lanche da Tarde', basePct: 15, type: 'post-mid-day' },
            { name: 'Jantar', basePct: 25, type: 'night' },
        ];
        
        // Estado Global do App
        let appState = {
            currentStep: 0,
            isPlanGenerated: false,
            profile: {}, // Armazena as respostas do formul√°rio
            generatedPlan: null,
            favorites: [],
        };

        // --- CATALOGO DE ALIMENTOS SIMPLIFICADO (FOOD BANK BR) ---
        // Adicionado: priceLevel (1=Baixo, 3=Alto) e prepTime (1=R√°pido, 3=Longo)
        const FOOD_CATALOG = {
            // [kcal, protein, fat, carb, tags, friendlyUnit]
            'protein': [
                { name: 'Peito de Frango (Grelhado)', k: 165, p: 31, g: 3.6, c: 0, tags: ['pf', 'marmita', 'carne'], unit: 'g', portionMin: 120, portionMax: 230, unitText: 'fil√©/palma', priceLevel: 2, prepTime: 2 },
                { name: 'Ovos (Cozidos)', k: 155, p: 13, g: 11, c: 1.1, tags: ['cafe', 'pratico'], unit: 'g', portionMin: 100, portionMax: 200, unitText: '2-4 ovos', priceLevel: 1, prepTime: 1 },
                { name: 'Iogurte Natural (2% gordura)', k: 60, p: 4, g: 2, c: 5, tags: ['cafe', 'pratico', 'lactose'], unit: 'ml', portionMin: 150, portionMax: 300, unitText: 'copo', priceLevel: 2, prepTime: 1 },
                { name: 'Atum Enlatado (√Ågua)', k: 116, p: 25, g: 1, c: 0, tags: ['pratico'], unit: 'g', portionMin: 80, portionMax: 150, unitText: 'lata', priceLevel: 2, prepTime: 1 },
                { name: 'Bife Patinho (Grelhado)', k: 131, p: 22, g: 4, c: 0, tags: ['pf', 'carne'], unit: 'g', portionMin: 120, portionMax: 230, unitText: 'bife', priceLevel: 3, prepTime: 2 },
                // Adicional para Veg
                { name: 'Tofu (Extra Firme)', k: 76, p: 8, g: 4.8, c: 1.9, tags: ['pf', 'marmita', 'vegan', 'natural'], unit: 'g', portionMin: 100, portionMax: 250, unitText: 'peda√ßo', priceLevel: 2, prepTime: 2 },
            ],
            'carb': [
                { name: 'Arroz Branco', k: 130, p: 2.7, g: 0.3, c: 28, tags: ['pf', 'gluten-free'], unit: 'g', portionMin: 100, portionMax: 260, unitText: 'colher (grande)', priceLevel: 1, prepTime: 2 },
                { name: 'Arroz Integral', k: 112, p: 2.6, g: 1, c: 24, tags: ['pf', 'natural', 'gluten-free'], unit: 'g', portionMin: 100, portionMax: 260, unitText: 'colher (grande)', priceLevel: 1, prepTime: 3 },
                { name: 'Batata Doce (Cozida)', k: 76, p: 1.6, g: 0.1, c: 17, tags: ['marmita', 'natural', 'gluten-free'], unit: 'g', portionMin: 100, portionMax: 250, unitText: 'peda√ßo m√©dio', priceLevel: 1, prepTime: 3 },
                { name: 'P√£o Integral', k: 250, p: 10, g: 4, c: 45, tags: ['cafe', 'pratico', 'gluten'], unit: 'g', portionMin: 50, portionMax: 100, unitText: '2 fatias', priceLevel: 2, prepTime: 1 },
                { name: 'Macarr√£o Integral', k: 150, p: 5, g: 1, c: 30, tags: ['pratico', 'gluten'], unit: 'g', portionMin: 100, portionMax: 200, unitText: 'x√≠cara (cozido)', priceLevel: 2, prepTime: 2 },
                { name: 'Aveia em Flocos', k: 389, p: 17, g: 7, c: 66, tags: ['cafe', 'natural'], unit: 'g', portionMin: 30, portionMax: 80, unitText: 'colher (sopa)', priceLevel: 1, prepTime: 1 },
            ],
            'fat': [
                { name: 'Azeite Extra Virgem', k: 884, p: 0, g: 100, c: 0, tags: [], unit: 'ml', portionMin: 3, portionMax: 12, unitText: 'colher (ch√°/sopa)', priceLevel: 2, prepTime: 1 },
                { name: 'Pasta de Amendoim', k: 588, p: 25, g: 50, c: 20, tags: ['pratico'], unit: 'g', portionMin: 15, portionMax: 40, unitText: 'colher (sopa)', priceLevel: 2, prepTime: 1 },
                { name: 'Queijo Mu√ßarela', k: 300, p: 22, g: 22, c: 1, tags: ['cafe', 'lactose'], unit: 'g', portionMin: 30, portionMax: 60, unitText: '1 fatia', priceLevel: 2, prepTime: 1 },
            ],
            'fruit': [
                { name: 'Banana', k: 89, p: 1.1, g: 0.3, c: 23, tags: ['cafe', 'natural'], unit: 'g', portionMin: 80, portionMax: 150, unitText: '1 unidade', priceLevel: 1, prepTime: 1 },
                { name: 'Ma√ß√£', k: 52, p: 0.3, g: 0.2, c: 14, tags: ['cafe', 'natural'], unit: 'g', portionMin: 100, portionMax: 200, unitText: '1 unidade', priceLevel: 1, prepTime: 1 },
                { name: 'Feij√£o Carioca', k: 76, p: 5, g: 0.5, c: 14, tags: ['pf', 'natural', 'gluten-free'], unit: 'g', portionMin: 100, portionMax: 200, unitText: 'concha', priceLevel: 1, prepTime: 3 },
            ],
        };

        // --- TEMPLATES DE REFEI√á√ïES (BR) ---
        const MEAL_TEMPLATES = {
            'Caf√© da Manh√£': [
                { id: 'CM1', name: '(1) P√£o + Prote√≠na + Fruta', familyRatios: { P: 40, C: 45, G: 15 }, items: [{ type: 'carb', tag: 'P√£o' }, { type: 'protein', tag: 'cafe' }, { type: 'fruit' }] },
                { id: 'CM2', name: '(2) Iogurte + Aveia + Fruta', familyRatios: { P: 35, C: 50, G: 15 }, items: [{ type: 'protein', tag: 'Iogurte' }, { type: 'carb', tag: 'Aveia' }, { type: 'fruit' }] },
                { id: 'CM3', name: '(3) Ovos + Raiz + Fruta', familyRatios: { P: 45, C: 40, G: 15 }, items: [{ type: 'protein', tag: 'Ovo' }, { type: 'carb', tag: 'Raiz' }, { type: 'fruit' }] },
            ],
            'Almo√ßo/Jantar': [
                { id: 'PF1', name: '(A) PF Brasileiro Cl√°ssico', familyRatios: { P: 40, C: 40, G: 20 }, items: [{ type: 'protein', tag: 'pf' }, { type: 'carb', tag: 'Arroz' }, { type: 'fruit', tag: 'Feij√£o' }, { type: 'fat', tag: 'Azeite' }] },
                { id: 'MR2', name: '(B) Marmita Simples (Raiz)', familyRatios: { P: 45, C: 35, G: 20 }, items: [{ type: 'protein', tag: 'marmita' }, { type: 'carb', tag: 'Raiz' }, { type: 'fat', tag: 'Azeite' }] },
                { id: 'MS3', name: '(D) Massa Fit', familyRatios: { P: 35, C: 45, G: 20 }, items: [{ type: 'carb', tag: 'Macarr√£o' }, { type: 'protein', tag: 'marmita' }, { type: 'fat', tag: 'Azeite' }] },
            ],
            'Lanche da Tarde': [
                { id: 'LT1', name: '(L1) P√£o + Pasta', familyRatios: { P: 30, C: 40, G: 30 }, items: [{ type: 'carb', tag: 'P√£o' }, { type: 'fat', tag: 'Pasta' }] },
                { id: 'LT2', name: '(L2) Iogurte + Fruta', familyRatios: { P: 45, C: 45, G: 10 }, items: [{ type: 'protein', tag: 'Iogurte' }, { type: 'fruit' }] },
            ]
        };
        // --- FUN√á√ïES UTILIT√ÅRIAS ---

        /**
         * Exibe o overlay de carregamento.
         * @param {string} message Mensagem a ser exibida.
         */
        function showLoading(message = "Processando dados...") {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');
        }

        /**
         * Esconde o overlay de carregamento.
         */
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('flex');
        }

        // Exibe o modal
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('app-modal').classList.remove('hidden');
            document.getElementById('app-modal').classList.add('flex');
        }

        // Esconde o modal
        function hideModal() {
            document.getElementById('app-modal').classList.add('hidden');
            document.getElementById('app-modal').classList.remove('flex');
        }

        // Exibe mensagem de feedback
        function showMessage(text, isError = false) {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = text;
            messageArea.classList.remove('hidden', 'bg-red-500', 'bg-accent-light', 'text-secondary-dark');
            if (isError) {
                messageArea.classList.add('bg-danger');
                messageArea.classList.remove('bg-accent-light', 'text-secondary-dark');
            } else {
                messageArea.classList.add('bg-accent-light', 'text-secondary-dark');
                messageArea.classList.remove('bg-danger');
            }
        }

        // Armazena o estado no localStorage
        function saveState(key, data) {
            try {
                localStorage.setItem(`${APP_ID}-${key}`, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error("Erro ao salvar estado local:", e);
                return false;
            }
        }

        // Carrega o estado do localStorage
        function loadState(key) {
            try {
                const data = localStorage.getItem(`${APP_ID}-${key}`);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error("Erro ao carregar estado local:", e);
                return null;
            }
        }

        // --- FUN√á√ïES DE C√ÅLCULO CORE ---

        /**
         * Mifflin-St Jeor para BMR
         */
        function calculateBMR(sex, weight, height, age) {
            if (sex === 'masculino') return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            if (sex === 'feminino') return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            return 0;
        }

        /**
         * Calcula o Gasto Energ√©tico Di√°rio Total (TDEE)
         */
        function calculateTDEE(bmr, activity, intensity, sleep) {
            let tdee = bmr * (TDEE_MULTIPLIERS[activity] || 1.2);
            if (intensity === 'alta') tdee *= 1.05;
            if (intensity === 'baixa') tdee *= 0.97;
            if (sleep === 'menos_6h') tdee *= 0.97;
            return Math.round(tdee);
        }

        /**
         * Calcula a Meta Cal√≥rica Di√°ria
         */
        function calculateCaloricGoal(tdee, objective) {
            switch (objective) {
                case 'perder_gordura': return Math.round(tdee * 0.85); // Cut: TDEE -15%
                case 'ganhar_massa': return Math.round(tdee * 1.08); // Bulk: TDEE +8%
                case 'recomposicao': default: return tdee; // Manuten√ß√£o
            }
        }

        /**
         * Filtra alimentos por restri√ß√µes e lista de evitar.
         * @returns {Array<Object>} Candidatos compat√≠veis.
         */
        function filterFood(family, restrictions, avoidList) {
            let candidates = FOOD_CATALOG[family] || [];
            const isGlutenFree = restrictions.includes('sem_gluten');
            const isLactoseFree = restrictions.includes('sem_lactose');
            const isVeg = restrictions.includes('vegetariano');
            const isVegan = restrictions.includes('vegan');

            return candidates.filter(food => {
                if (isGlutenFree && food.tags.includes('gluten')) return false;
                if (isLactoseFree && food.tags.includes('lactose')) return false;
                // Veganos/Vegetarianos: Excluem carnes, mas permitem frutas e vegetais
                if ((isVegan || isVeg) && food.tags.includes('carne')) return false; 
                if (isVegan && !food.tags.includes('vegan') && food.family !== 'fruit') return false; 
                
                if (avoidList.some(keyword => food.name.toLowerCase().includes(keyword.toLowerCase()))) return false;
                return true;
            });
        }
        
        /**
         * [CORE NEW LOGIC] Calcula o score de um template de refei√ß√£o com base nas prefer√™ncias e dispensa.
         * @param {Object} template - Template da refei√ß√£o (CM1, PF1, etc.).
         * @param {Object} profile - Perfil do usu√°rio.
         * @returns {number} Score de adequa√ß√£o.
         */
        function calculateTemplateScore(template, profile) {
            let score = 100; // Base Score
            const { style, time, budget, restrictions, useDispensa, dispensa, costumo, avoidList } = profile;
            
            // Mapeamento de perfis num√©ricos
            const targetBudget = BUDGET_MAP[budget];
            const targetTime = TIME_MAP[time];
            
            let foodList = [];
            
            // 1. Penaliza√ß√£o por Incompatibilidade de Alimentos (Restri√ß√µes)
            for (const item of template.items) {
                const candidates = filterFood(item.type, restrictions, avoidList);
                if (candidates.length === 0) {
                    score -= 50; // Penalidade forte se faltar um item essencial
                } else {
                    // Seleciona o primeiro candidato compat√≠vel para an√°lise de score
                    foodList.push(candidates[0]);
                }
            }

            // Se a penalidade for muito alta, retornar score baixo para descarte
            if (score <= 50) return score;

            // 2. Pontua√ß√£o Baseada em Prefer√™ncias (Estilo, Tempo, Or√ßamento)
            
            foodList.forEach(food => {
                // A. Estilo (Natural vs Pr√°tico)
                if (style === 'natural' && food.tags.includes('natural')) score += 5;
                if (style === 'pratico' && food.tags.includes('pratico')) score += 5;
                if (style === 'natural' && food.tags.includes('pratico')) score -= 5; // Penaliza pr√°tico se o estilo for natural

                // B. Or√ßamento e Tempo 
                if (food.priceLevel <= targetBudget) score += 3;
                if (food.priceLevel > targetBudget) score -= 5; // Penaliza caro
                
                if (food.prepTime <= targetTime) score += 3; // R√°pido √© bom
                if (food.prepTime > targetTime) score -= 5; // Penaliza longo
                
                // C. PRIORIZA√á√ÉO (Dispensa/H√°bitos) - Ponto 4 do plano
                if (useDispensa) {
                    const foodNameLower = food.name.toLowerCase();
                    const dispensaLower = dispensa.map(s => s.toLowerCase());
                    const costumoLower = costumo.map(s => s.toLowerCase());

                    // B√¥nus se o alimento estiver em casa
                    if (dispensaLower.some(item => foodNameLower.includes(item))) score += 10;
                    // B√¥nus se for um h√°bito real
                    if (costumoLower.some(item => foodNameLower.includes(item))) score += 5;
                }
            });
            
            // 3. Desempate pelo Objetivo (Cut/Bulk)
            // Cut (Perder Gordura): Favorece Prote√≠na e desfavorece Carbo muito alto.
            if (profile.objective === 'perder_gordura' && template.familyRatios.C > 45) score -= 5; 
            // Bulk (Ganhar Massa): Favorece Carbo alto e densidade cal√≥rica.
            if (profile.objective === 'ganhar_massa' && template.familyRatios.C > 40) score += 5; 

            return score;
        }


        /**
         * Motor de Gera√ß√£o de Refei√ß√µes (Daily Plan)
         */
        function generateDailyPlan(profile) {
            const { sex, weight, height, age, activity, intensity, sleep, objective, numMeals, restrictions, avoidList, trainingTime, hungerTime } = profile;

            // 1. C√°lculos de TDEE e Meta Cal√≥rica
            const bmr = calculateBMR(sex, weight, height, age);
            const tdee = calculateTDEE(bmr, activity, intensity, sleep);
            const goalKcal = calculateCaloricGoal(tdee, objective);

            if (goalKcal <= 0) {
                 showModal("Erro de C√°lculo", "N√£o foi poss√≠vel calcular sua meta cal√≥rica. Verifique os dados f√≠sicos.");
                 return null;
            }

            // 2. Distribui√ß√£o Cal√≥rica Din√¢mica (Ponto 2 do plano)
            const mealSlots = [];
            let currentDistribution = CALORIE_DISTRIBUTION_BASE.slice(0, numMeals);
            
            // --- Mapeamento de √çndices ---
            let trainingIndex = -1;
            if (profile.training === 'sim' && trainingTime) {
                if (trainingTime === 'manha' && numMeals >= 3) trainingIndex = 0; // CM
                if (trainingTime === 'tarde' && numMeals >= 4) trainingIndex = 1; // ALMO√áO
                if (trainingTime === 'noite' && numMeals >= 4) trainingIndex = currentDistribution.length - 1; // JANTA
            }
            
            let hungerIndex = -1;
            if (hungerTime === 'manha') hungerIndex = 0;
            if (hungerTime === 'tarde' && numMeals >= 4) hungerIndex = 2; // Lanche da Tarde
            if (hungerTime === 'noite' && numMeals >= 4) hungerIndex = currentDistribution.length - 1;

            // Aplicar ajustes
            currentDistribution.forEach((slot, index) => {
                let adjustment = 0;
                
                // Ajuste de Treino: +12% no treino; +6% na anterior/seguinte
                if (index === trainingIndex) {
                    adjustment += 12; 
                } else if (index === trainingIndex - 1 || index === trainingIndex + 1) {
                    adjustment += 6; 
                }
                
                // Ajuste de Fome: +8%
                if (index === hungerIndex) {
                    adjustment += 8; 
                }
                
                slot.targetPct = slot.basePct + adjustment;
                mealSlots.push(slot);
            });
            
            // Normaliza e calcula Kcal alvo (Clamp impl√≠cito na normaliza√ß√£o)
            const sumPct = mealSlots.reduce((sum, slot) => sum + slot.targetPct, 0);
            mealSlots.forEach(slot => {
                slot.targetPct = (slot.targetPct / sumPct); // Normaliza para 1.0 (100%)
                slot.targetKcal = Math.round(goalKcal * slot.targetPct);
            });

            // 3. Sele√ß√£o de Templates por Score (Ponto 1 do plano)
            const dailyPlan = { goalKcal, bmr, tdee, meals: [] };
            
            for (const mealSlot of mealSlots) {
                const mealKcal = mealSlot.targetKcal;
                let templateType = mealSlot.name.includes('Caf√©') ? 'Caf√© da Manh√£' : (mealSlot.name.includes('Lanche') ? 'Lanche da Tarde' : 'Almo√ßo/Jantar');

                const templates = MEAL_TEMPLATES[templateType];
                let bestTemplate = null;
                let maxScore = -Infinity;

                templates.forEach(template => {
                    const score = calculateTemplateScore(template, profile);
                    if (score > maxScore) {
                        maxScore = score;
                        bestTemplate = template;
                    }
                });
                
                if (!bestTemplate) {
                     showModal("Erro de Gera√ß√£o", `N√£o foi poss√≠vel encontrar um template compat√≠vel para ${mealSlot.name}. Tente relaxar algumas restri√ß√µes.`);
                     return null;
                }

                const meal = {
                    name: mealSlot.name,
                    template: bestTemplate.name,
                    kcal: mealKcal,
                    items: [],
                    totalKcal: 0,
                    score: maxScore,
                    variants: [] 
                };

                // 4. Sele√ß√£o de Alimentos e Por√ß√µes com Hard Caps (Ponto 3 do plano)
                let totalKcalGenerated = 0;
                let initialItems = [];

                for (const item of bestTemplate.items) {
                    const family = item.type;
                    const foodCandidates = filterFood(family, restrictions, avoidList);
                    
                    if (foodCandidates.length === 0) continue;

                    // Sele√ß√£o Inteligente do Alimento: Pega o alimento mais compat√≠vel com as prefer√™ncias (Or√ßamento/Tempo/Estilo)
                    // Simplifica√ß√£o: o primeiro alimento no array filtrado √© usado, assumindo que ele j√° √© o "melhor" para aquela fam√≠lia/tag.
                    const selectedFood = foodCandidates[0]; 

                    // Por√ß√£o inicial arbitr√°ria dentro do range (m√©dia) para base de c√°lculo
                    const basePortionGrams = Math.round((selectedFood.portionMin + selectedFood.portionMax) / 2);
                    
                    let kcalItem = (basePortionGrams / 100) * selectedFood.k;
                    totalKcalGenerated += kcalItem;

                    initialItems.push({
                        name: selectedFood.name, family, kcalPer100: selectedFood.k,
                        unit: selectedFood.unit, unitText: selectedFood.unitText, kcalItem,
                        grams: basePortionGrams, baseFood: selectedFood
                    });
                }
                
                // Ajuste de Escala para Atingir Kcal da Refei√ß√£o
                if (totalKcalGenerated > 0) {
                    const scaleFactor = mealKcal / totalKcalGenerated;
                    let currentTotalKcal = 0;

                    initialItems.forEach(item => {
                        if (item.grams > 0 && item.baseFood) {
                            
                            // 1. Escala (Tenta atingir a meta)
                            let finalGrams = item.grams * scaleFactor;
                            const base = item.baseFood;
                            
                            // 2. Hard Caps (Ponto 3 do plano)
                            if (finalGrams < base.portionMin) finalGrams = base.portionMin;
                            if (finalGrams > base.portionMax) finalGrams = base.portionMax;
                            
                            // 3. Arredondamento e Rec√°lculo Final de Kcal
                            item.grams = Math.round(finalGrams);
                            item.kcalItem = Math.round((item.grams / 100) * item.kcalPer100);
                        }
                        currentTotalKcal += item.kcalItem;
                    });
                    
                    meal.items = initialItems;
                    meal.totalKcal = currentTotalKcal;
                }

                dailyPlan.meals.push(meal);
            }

            dailyPlan.totalKcal = dailyPlan.meals.reduce((sum, meal) => sum + meal.totalKcal, 0);
            return dailyPlan;
        }
        
        // --- FUN√á√ÉO ASS√çNCRONA PARA MOSTRAR O LOADING ---
        function generatePlanAsync(profile) {
            showLoading("Otimizando as calorias para seu treino, prefer√™ncias e dispensa...");
            
            setTimeout(() => {
                const plan = generateDailyPlan(profile);
                if (plan) {
                    appState.generatedPlan = plan;
                    appState.isPlanGenerated = true;
                    renderApp();
                    showMessage("‚úÖ Plano gerado com sucesso! Revise os detalhes.", false);
                }
                hideLoading();
            }, 800); // Aumentei o mock delay para 800ms para corresponder √† complexidade percebida da nova l√≥gica
        }

        // --- FUN√á√ïES DE PERSIST√äNCIA E EXPORTA√á√ÉO ---

        function saveProfile() {
            if (saveState('profile', appState.profile)) {
                showMessage("‚úÖ Perfil salvo com sucesso!", false);
            } else {
                showMessage("üî¥ Erro ao salvar perfil.", true);
            }
        }

        function loadProfile() {
            const profile = loadState('profile');
            if (profile) {
                appState.profile = profile;
                appState.currentStep = 0; // Volta para o in√≠cio para re-renderizar o form preenchido
                renderApp();
                showMessage("‚úÖ Perfil carregado! Clique em 'Gerar Plano' para continuar.", false);
            } else {
                showMessage("üî¥ Nenhum perfil encontrado localmente.", true);
            }
        }

        function saveFavoritePlan() {
            const newFav = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('pt-BR'),
                profile: appState.profile,
                plan: appState.generatedPlan
            };

            let favorites = loadState('favorites') || [];
            // Limitar a N favoritos (ex: 10)
            if (favorites.length >= 10) favorites.shift(); 
            
            favorites.push(newFav);
            if (saveState('favorites', favorites)) {
                showMessage("‚≠ê Plano salvo como Favorito!", false);
                appState.favorites = favorites;
            } else {
                showMessage("üî¥ Erro ao salvar favorito.", true);
            }
        }
        
        // Exporta√ß√£o para PNG/PDF
        function exportPlan(format) {
            const planSection = document.getElementById('plan-output');
            if (!planSection) {
                showMessage("üî¥ O plano n√£o foi gerado para exporta√ß√£o.", true);
                return;
            }

            showLoading(`Preparando ${format.toUpperCase()} para exporta√ß√£o...`);

            // Usa html2canvas para renderizar a div em uma imagem
            html2canvas(planSection, {
                scale: 2, // Maior resolu√ß√£o
                backgroundColor: '#1e293b',
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');

                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = `FitPlan_PNG_${Date.now()}.png`;
                    link.href = imgData;
                    link.click();
                    showMessage("‚úÖ PNG exportado com sucesso!", false);
                }

                if (format === 'pdf') {
                    // Configura√ß√µes do PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height] // Define o PDF com o tamanho exato do conte√∫do
                    });

                    // Adiciona a imagem do canvas ao PDF
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`FitPlan_PDF_${Date.now()}.pdf`);
                    showMessage("‚úÖ PDF exportado com sucesso!", false);
                }
            }).catch(error => {
                console.error("Erro na exporta√ß√£o:", error);
                showMessage("üî¥ Erro ao exportar. Tente novamente.", true);
            }).finally(() => {
                hideLoading();
            });
        }


        // --- FUN√á√ïES DE RENDERIZA√á√ÉO DA UI ---

        /**
         * Atualiza o Stepper
         */
        function renderStepper() {
            const stepperEl = document.getElementById('stepper');
            stepperEl.innerHTML = STEPS.map((step, index) => {
                const isCurrent = index === appState.currentStep;
                const isDone = index < appState.currentStep;
                // Adicionado w-1/5 para for√ßar o layout de 5 colunas
                let classes = 'w-1/5 text-center p-2 rounded-full text-xs sm:text-base cursor-pointer transition duration-300';
                
                if (isCurrent) {
                    classes += ' stepper-active ring-4 ring-accent-light';
                } else if (isDone) {
                    classes += ' stepper-done opacity-70 hover:opacity-100';
                } else {
                    classes += ' bg-slate-700 text-text-muted';
                }

                // Permite clicar nos passos conclu√≠dos
                const onClick = isDone || isCurrent ? `onclick="goToStep(${index})"` : '';

                return `<div class="${classes}" ${onClick} aria-label="Passo ${index + 1}: ${step.name}">${index + 1}</div>`; // Simplificando o texto do stepper
            }).join('');
        }
        
        /**
         * Navega entre os passos do formul√°rio
         */
        function goToStep(stepIndex) {
            if (stepIndex >= 0 && stepIndex < STEPS.length) {
                saveCurrentStepData();
                appState.currentStep = stepIndex;
                appState.isPlanGenerated = false; // For√ßa voltar para o formul√°rio
                renderApp();
            }
        }

        /**
         * Tooltip reutiliz√°vel
         */
        function getTooltip(text) {
             return `<span class="relative group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block tooltip-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="absolute z-10 hidden group-hover:block w-48 p-2 text-xs bg-slate-700 text-text-light rounded-lg shadow-lg bottom-full left-1/2 transform -translate-x-1/2 mb-2 whitespace-normal">${text}</span>
                    </span>`;
        }


        /**
         * Renderiza o formul√°rio do passo atual
         */
        function renderFormStep() {
            const step = STEPS[appState.currentStep];
            const contentEl = document.getElementById('app-content');
            const data = appState.profile;

            let html = `<div class="card p-6 sm:p-8">`;
            html += `<h2 class="text-2xl font-bold mb-6 text-accent">${appState.currentStep + 1}. ${step.name}</h2>`;
            html += `<form id="current-step-form" onsubmit="event.preventDefault(); nextStep();">`;

            // --- Campos do Formul√°rio ---
            switch (step.key) {
                case 'goal':
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Seu Objetivo Principal ${getTooltip('Define o d√©ficit ou super√°vit cal√≥rico necess√°rio para atingir sua meta.')}</label>
                        <select id="objective" name="objective" class="input-dark w-full p-3 rounded-lg" required>
                            <option value="" disabled selected>O que voc√™ quer conquistar?</option>
                            <option value="perder_gordura" ${data.objective === 'perder_gordura' ? 'selected' : ''}>Perder Gordura (Emagrecer)</option>
                            <option value="recomposicao" ${data.objective === 'recomposicao' ? 'selected' : ''}>Recomposi√ß√£o Corporal (Manter/melhorar)</option>
                            <option value="ganhar_massa" ${data.objective === 'ganhar_massa' ? 'selected' : ''}>Ganhar Massa Muscular (Volume)</option>
                        </select>
                    </div>`;
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Horizonte do Plano ${getTooltip('O tempo de dura√ß√£o do seu plano. Quanto maior o horizonte, mais variedade de alimentos o plano incluir√° ao longo da semana.')}</label>
                        <select id="horizonte" name="horizonte" class="input-dark w-full p-3 rounded-lg">
                            <option value="8_semanas" ${data.horizonte === '8_semanas' ? 'selected' : ''}>8 Semanas (Alta Variedade)</option>
                            <option value="12_semanas" ${data.horizonte === '12_semanas' ? 'selected' : ''}>12 Semanas (M√©dia Variedade)</option>
                            <option value="16_semanas" ${data.horizonte === '16_semanas' ? 'selected' : ''}>16 Semanas (Baixa Variedade)</option>
                        </select>
                    </div>`;
                    break;
                case 'body':
                    html += `<div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-text-muted mb-2">Sexo</label>
                            <select id="sex" name="sex" class="input-dark w-full p-3 rounded-lg" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="masculino" ${data.sex === 'masculino' ? 'selected' : ''}>Masculino</option>
                                <option value="feminino" ${data.sex === 'feminino' ? 'selected' : ''}>Feminino</option>
                            </select>
                        </div>
                        <div><label class="block text-text-muted mb-2">Idade (anos)</label>
                            <input type="number" id="age" name="age" value="${data.age || ''}" class="input-dark w-full p-3 rounded-lg" required min="16" max="99">
                        </div>
                    </div>`;
                    html += `<div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-text-muted mb-2">Altura (cm)</label>
                            <input type="number" id="height" name="height" value="${data.height || ''}" class="input-dark w-full p-3 rounded-lg" required min="100" max="250">
                        </div>
                        <div><label class="block text-text-muted mb-2">Peso (kg)</label>
                            <input type="number" id="weight" name="weight" value="${data.weight || ''}" class="input-dark w-full p-3 rounded-lg" required min="30" max="300">
                        </div>
                    </div>`;
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">N¬∫ de Refei√ß√µes/Dia</label>
                        <select id="numMeals" name="numMeals" class="input-dark w-full p-3 rounded-lg" required>
                            <option value="3" ${data.numMeals === '3' ? 'selected' : ''}>3 Refei√ß√µes</option>
                            <option value="4" ${data.numMeals === '4' ? 'selected' : ''}>4 Refei√ß√µes (Padr√£o: Caf√©/Almo√ßo/Lanche/Jantar)</option>
                            <option value="5" ${data.numMeals === '5' ? 'selected' : ''}>5 Refei√ß√µes</option>
                            <option value="6" ${data.numMeals === '6' ? 'selected' : ''}>6 Refei√ß√µes</option>
                        </select>
                    </div>`;
                    html += `<div class="text-text-muted mt-4 p-2 border-l-4 border-accent text-sm">
                        *Usamos seus dados para calcular sua necessidade cal√≥rica basal.
                    </div>`;
                    break;
                case 'routine':
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Seu N√≠vel de Atividade Di√°ria ${getTooltip('Ajusta seu Gasto Energ√©tico (TDEE). Seja honesto para ter um plano realista.')}</label>
                        <select id="activity" name="activity" class="input-dark w-full p-3 rounded-lg" required>
                            <option value="sedentario" ${data.activity === 'sedentario' ? 'selected' : ''}>Sedent√°rio (Trabalho sentado, pouco movimento)</option>
                            <option value="leve" ${data.activity === 'leve' ? 'selected' : ''}>Leve (Exerc√≠cio 1-3 dias/semana)</option>
                            <option value="moderado" ${data.activity === 'moderado' ? 'selected' : ''}>Moderado (Exerc√≠cio 3-5 dias/semana)</option>
                            <option value="ativo" ${data.activity === 'ativo' ? 'selected' : ''}>Ativo (Exerc√≠cio 6-7 dias/semana)</option>
                            <option value="atleta" ${data.activity === 'atleta' ? 'selected' : ''}>Atleta (Treinos 2x/dia)</option>
                        </select>
                    </div>`;
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Faz Treino de For√ßa (Muscula√ß√£o)?</label>
                        <select id="training" name="training" onchange="toggleTrainingFields(this.value)" class="input-dark w-full p-3 rounded-lg">
                            <option value="nao" ${data.training === 'nao' ? 'selected' : ''}>N√£o</option>
                            <option value="sim" ${data.training === 'sim' ? 'selected' : ''}>Sim (Ajustaremos as calorias pr√© e p√≥s-treino)</option>
                        </select>
                    </div>`;
                    
                    html += `<div id="training-fields" class="mb-4 ${data.training !== 'sim' ? 'hidden' : ''}">
                        <label class="block text-text-muted mb-2">Hor√°rio do Treino</label>
                        <select id="trainingTime" name="trainingTime" class="input-dark w-full p-3 rounded-lg">
                            <option value="manha" ${data.trainingTime === 'manha' ? 'selected' : ''}>Manh√£ (at√© 12h)</option>
                            <option value="tarde" ${data.trainingTime === 'tarde' ? 'selected' : ''}>Tarde (12h-18h)</option>
                            <option value="noite" ${data.trainingTime === 'noite' ? 'selected' : ''}>Noite (ap√≥s 18h)</option>
                        </select>
                        <label class="block text-text-muted mb-2 mt-4">Intensidade Percebida</label>
                        <select id="intensity" name="intensity" class="input-dark w-full p-3 rounded-lg">
                            <option value="baixa" ${data.intensity === 'baixa' ? 'selected' : ''}>Baixa (F√°cil/Moderado)</option>
                            <option value="media" ${data.intensity === 'media' ? 'selected' : ''}>M√©dia (Normal/Pesado)</option>
                            <option value="alta" ${data.intensity === 'alta' ? 'selected' : ''}>Alta (Muito Pesado/Exaustivo)</option>
                        </select>
                    </div>`;
                    // NOVO CAMPO DE FOME
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Hor√°rio de Maior Fome ${getTooltip('O plano ajustar√° as calorias (+8%) para esta refei√ß√£o, auxiliando na saciedade.')}</label>
                        <select id="hungerTime" name="hungerTime" class="input-dark w-full p-3 rounded-lg">
                            <option value="none" ${data.hungerTime === 'none' ? 'selected' : ''}>N√£o se aplica / Fome est√°vel</option>
                            <option value="manha" ${data.hungerTime === 'manha' ? 'selected' : ''}>Manh√£ (Ajusta Caf√© da Manh√£)</option>
                            <option value="tarde" ${data.hungerTime === 'tarde' ? 'selected' : ''}>Tarde (Ajusta Lanche da Tarde)</option>
                            <option value="noite" ${data.hungerTime === 'noite' ? 'selected' : ''}>Noite (Ajusta Jantar)</option>
                        </select>
                    </div>`;
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Horas de Sono ${getTooltip('O sono afeta o metabolismo. Dormir menos de 6h resulta em um pequeno ajuste negativo no gasto cal√≥rico.')}</label>
                        <select id="sleep" name="sleep" class="input-dark w-full p-3 rounded-lg">
                            <option value="mais_6h" ${data.sleep === 'mais_6h' ? 'selected' : ''}>6h ou Mais</option>
                            <option value="menos_6h" ${data.sleep === 'menos_6h' ? 'selected' : ''}>Menos de 6h</option>
                        </select>
                    </div>`;
                    break;
                case 'prefs':
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Estilo de Alimenta√ß√£o</label>
                        <select id="style" name="style" class="input-dark w-full p-3 rounded-lg">
                            <option value="indiferente" ${data.style === 'indiferente' ? 'selected' : ''}>Indiferente</option>
                            <option value="natural" ${data.style === 'natural' ? 'selected' : ''}>Mais Natural (Gr√£os integrais, menos industrializados)</option>
                            <option value="pratico" ${data.style === 'pratico' ? 'selected' : ''}>Mais Pr√°tico (Rapidez, enlatados/congelados)</option>
                        </select>
                    </div>`;
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Tempo de Preparo Di√°rio</label>
                        <select id="time" name="time" class="input-dark w-full p-3 rounded-lg">
                            <option value="lt_15" ${data.time === 'lt_15' ? 'selected' : ''}>< 15 min (Refei√ß√µes ultra-r√°pidas)</option>
                            <option value="15_30" ${data.time === '15_30' ? 'selected' : ''}>15‚Äì30 min (Ideal para marmita simples)</option>
                            <option value="gt_30" ${data.time === 'gt_30' ? 'selected' : ''}>> 30 min (Refei√ß√µes mais elaboradas)</option>
                        </select>
                    </div>`;
                    html += `<div class="mb-4">
                        <label class="block text-text-muted mb-2">Or√ßamento</label>
                        <select id="budget" name="budget" class="input-dark w-full p-3 rounded-lg">
                            <option value="baixo" ${data.budget === 'baixo' ? 'selected' : ''}>Baixo (Prioriza ovos, frango, arroz e ra√≠zes)</option>
                            <option value="medio" ${data.budget === 'medio' ? 'selected' : ''}>M√©dio</option>
                            <option value="alto" ${data.budget === 'alto' ? 'selected' : ''}>Alto (Permite peixes e cortes mais nobres)</option>
                        </select>
                    </div>`;
                    
                    // Restri√ß√µes (Multi-select simplificado como Checkbox)
                    html += `<label class="block text-text-muted mb-2 mt-4">Restri√ß√µes</label>
                    <div class="space-y-2">
                        ${['sem_lactose', 'sem_gluten', 'vegetariano', 'vegan'].map(r => `
                            <label class="flex items-center">
                                <input type="checkbox" name="restrictions" value="${r}" class="h-5 w-5 text-accent rounded form-checkbox input-dark" ${data.restrictions && data.restrictions.includes(r) ? 'checked' : ''}>
                                <span class="ml-2 text-text-light">${r.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            </label>
                        `).join('')}
                    </div>`;
                    html += `<div class="mt-6">
                        <label class="block text-text-muted mb-2">Evitar (ex: peixe, castanhas)</label>
                        <input type="text" id="avoidList" name="avoidList" value="${(data.avoidList || []).join(', ')}" class="input-dark w-full p-3 rounded-lg" placeholder="Separado por v√≠rgulas">
                    </div>`;
                    break;
                case 'pantry':
                    html += `<div class="mb-4 flex items-center justify-between p-3 card border-accent border-2">
                        <label class="text-xl font-bold">Usar Dispensa / H√°bitos?</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="useDispensa" name="useDispensa" class="sr-only peer" ${data.useDispensa ? 'checked' : ''} onchange="toggleDispensaFields(this.checked)">
                            <div class="w-11 h-6 bg-slate-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                            <span class="ml-3 text-sm font-medium text-text-light">${data.useDispensa ? 'ON' : 'OFF'}</span>
                        </label>
                    </div>`;
                    
                    html += `<div id="dispensa-fields" class="mt-4 space-y-4 ${!data.useDispensa ? 'hidden' : ''}">
                        <div>
                            <label class="block text-text-muted mb-2">Com o que tenho em casa (dispensa)</label>
                            <textarea id="dispensa" name="dispensa" class="input-dark w-full p-3 rounded-lg h-24" placeholder="Itens que voc√™ tem na geladeira/arm√°rio, separado por v√≠rgulas (ex: Arroz, Ovos, Frango, Ma√ß√£)">${(data.dispensa || []).join(', ')}</textarea>
                        </div>
                        <div>
                            <label class="block text-text-muted mb-2">Costumo comer (h√°bitos reais)</label>
                            <textarea id="costumo" name="costumo" class="input-dark w-full p-3 rounded-lg h-24" placeholder="Itens que voc√™ costuma ter na dieta (ex: Batata doce, Azeite, Caf√©)">${(data.costumo || []).join(', ')}</textarea>
                        </div>
                        <p class="text-sm text-text-muted italic">O gerador dar√° prioridade a esses itens. Se OFF, esses campos s√£o ignorados.</p>
                    </div>`;
                    
                    break;
            }

            html += `</form>`; // Fecha o formul√°rio

            // Bot√µes de navega√ß√£o
            html += `<div class="flex justify-between mt-8 pt-4 border-t border-slate-700">`;
            if (appState.currentStep > 0) {
                html += `<button onclick="prevStep()" class="bg-slate-600 text-text-light font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition duration-200">
                            ‚Üê Anterior
                         </button>`;
            } else {
                 html += `<div><button onclick="loadProfile()" class="bg-slate-700 text-text-light py-2 px-4 rounded-lg hover:bg-slate-600 transition duration-200">
                             Carregar Perfil
                         </button></div>`;
            }

            if (appState.currentStep < STEPS.length - 1) {
                html += `<button onclick="nextStep()" class="bg-accent text-secondary-dark font-bold py-2 px-4 rounded-lg hover:bg-accent-light transition duration-200">
                            Pr√≥ximo ‚Üí
                         </button>`;
            } else {
                // CTA final agora usa a cor ACCENT (verde)
                html += `<button onclick="nextStep()" class="bg-accent text-secondary-dark font-bold py-2 px-4 rounded-lg hover:bg-accent-light transition duration-200">
                            üöÄ Gerar Plano!
                         </button>`;
            }
            html += `</div></div>`; // Fecha card e div

            contentEl.innerHTML = html;

            // Re-bind listener para toggle (necess√°rio ap√≥s renderiza√ß√£o)
            if (step.key === 'routine') {
                const trainingSelect = document.getElementById('training');
                if (trainingSelect) trainingSelect.onchange = (e) => toggleTrainingFields(e.target.value);
            }
            if (step.key === 'pantry') {
                const dispensaCheckbox = document.getElementById('useDispensa');
                if (dispensaCheckbox) dispensaCheckbox.onchange = (e) => toggleDispensaFields(e.target.checked);
            }
        }

        /**
         * Renderiza a sa√≠da do Plano de Refei√ß√µes
         */
        function renderPlanOutput() {
            const contentEl = document.getElementById('app-content');
            const plan = appState.generatedPlan;
            if (!plan) {
                contentEl.innerHTML = `<div class="card text-center p-12"><h2 class="text-2xl text-danger font-bold mb-4">Plano N√£o Gerado</h2><p>Por favor, complete os 5 passos e clique em 'Gerar Plano'.</p></div>`;
                return;
            }

            const dailyPlanHtml = generatePlanHtml(plan, appState.profile.numMeals);
            const shoppingListHtml = generateShoppingListHtml(plan);

            let html = `
                <div class="card p-4 sm:p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b border-slate-700 pb-4">
                        <h2 class="text-3xl font-extrabold text-accent mb-2 sm:mb-0">Seu Plano Gerado</h2>
                        <div class="flex space-x-2">
                            <button onclick="saveFavoritePlan()" class="p-2 rounded-full bg-slate-700 hover:bg-slate-600 text-yellow-400" title="Salvar Favorito">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </button>
                            <button onclick="exportPlan('png')" class="py-2 px-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-text-light text-sm">
                                Exportar PNG
                            </button>
                            <button onclick="exportPlan('pdf')" class="py-2 px-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-text-light text-sm">
                                Exportar PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Aba de navega√ß√£o (Dia √önico / Lista de Compras) -->
                    <div class="flex border-b border-slate-700 mb-6">
                        <button id="tab-plan" onclick="showTab('plan')" class="tab-active py-2 px-4">Plano (Dia 1)</button>
                        <button id="tab-shopping" onclick="showTab('shopping')" class="py-2 px-4">Lista de Compras (Dia)</button>
                    </div>

                    <!-- Informa√ß√µes Gerais (Clareza sobre termos t√©cnicos) -->
                    <div class="p-3 bg-slate-700 rounded-lg mb-6 flex justify-around text-center text-sm font-medium">
                        <div><span class="text-text-muted">Meta Cal√≥rica:</span> <span class="text-accent">${plan.goalKcal} kcal</span></div>
                        <div><span class="text-text-muted">Gasto Est. (TDEE):</span> <span class="text-text-light">${plan.tdee} kcal</span></div>
                        <div><span class="text-text-muted">Plano Total:</span> <span class="text-text-light">${plan.totalKcal} kcal</span></div>
                    </div>
                </div>

                <!-- Conte√∫do do Plano (Div para Exporta√ß√£o) -->
                <div id="plan-output" class="p-4 sm:p-6 card shadow-2xl">
                    <div id="plan-content">${dailyPlanHtml}</div>
                    <div id="shopping-content" class="hidden">${shoppingListHtml}</div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="goToStep(0)" class="bg-slate-600 text-text-light font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition duration-200">
                        ‚Üê Voltar ao Formul√°rio
                    </button>
                    <button onclick="saveProfile()" class="bg-accent text-secondary-dark font-bold py-2 px-4 rounded-lg hover:bg-accent-light transition duration-200">
                        üíæ Salvar Perfil
                    </button>
                </div>
            `;
            contentEl.innerHTML = html;
        }

        /**
         * Gera o HTML da Lista de Compras
         */
        function generateShoppingListHtml(plan) {
            const shoppingList = {};
            // Agrega todos os itens de todas as refei√ß√µes
            plan.meals.forEach(meal => {
                meal.items.forEach(item => {
                    if (item.grams > 0) {
                        const key = item.name;
                        const quantity = item.grams;
                        if (shoppingList[key]) {
                            shoppingList[key] += quantity;
                        } else {
                            shoppingList[key] = quantity;
                        }
                    }
                });
            });

            const items = Object.entries(shoppingList).map(([name, totalGrams]) => {
                // Convers√£o amig√°vel (muito simplificada)
                let displayQuantity = `${Math.round(totalGrams)}g`;
                if (totalGrams > 1000) displayQuantity = `${(totalGrams / 1000).toFixed(1)}kg`;
                
                return `<li class="flex justify-between items-center py-2 border-b border-slate-700">
                            <span class="text-text-light">${name}</span>
                            <span class="text-accent font-bold">${displayQuantity}</span>
                        </li>`;
            }).join('');

            return `
                <h3 class="text-2xl font-bold mb-4 text-accent">Lista de Compras (Dia √önico)</h3>
                <p class="text-text-muted mb-4">Esta lista detalha as quantidades necess√°rias para cumprir o plano de ${appState.profile.numMeals} refei√ß√µes em um dia. Para um plano semanal, multiplique!</p>
                <ul class="divide-y divide-slate-700 list-none p-0 m-0">
                    ${items.length > 0 ? items : '<li class="text-text-muted text-center py-4">Nenhum item gerado para a lista.</li>'}
                </ul>
            `;
        }


        /**
         * Gera o HTML para o Plano do Dia √önico (D1)
         */
        function generatePlanHtml(plan) {
            return plan.meals.map(meal => {
                const itemsHtml = meal.items.map(item => `
                    <li class="flex justify-between text-sm py-1">
                        <span class="text-text-muted">${item.name}</span>
                        <span class="text-text-light font-medium">
                            ${Math.round(item.grams)} ${item.baseFood ? item.baseFood.unit : 'g'} <span class="text-xs text-accent">(${item.baseFood ? item.baseFood.unitText : 'por√ß√£o'})</span>
                        </span>
                    </li>
                `).join('');

                return `
                    <div class="card p-4 mb-4">
                        <div class="flex justify-between items-center border-b border-slate-600 pb-2 mb-3">
                            <h3 class="text-xl font-bold text-accent-light">${meal.name}</h3>
                            <span class="text-lg font-extrabold text-accent">${meal.totalKcal} kcal</span>
                        </div>
                        <p class="text-xs text-text-muted italic mb-3">Sugest√£o de Prato: ${meal.template} (Score: ${meal.score.toFixed(1)})</p>
                        <ul class="list-none p-0 m-0 space-y-1">
                            ${itemsHtml}
                        </ul>
                        <!-- L√≥gica de Substitui√ß√£o (Mockup) -->
                        <div class="mt-4 text-right">
                             <button onclick="showModal('Substitui√ß√£o de Alimento', 'FUNCIONALIDADE FUTURA: Esta fun√ß√£o permitir√° que voc√™ troque um alimento por outro similar (ex: Arroz por Batata Doce), recalculando as por√ß√µes para manter as Kcal da refei√ß√£o.')" class="text-sm text-yellow-400 hover:text-yellow-300 transition duration-200">
                                üîÑ Trocar Alimento (Pr√≥ximo M√≥dulo)
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- FUN√á√ïES DE CONTROLE DO APP ---

        /**
         * Salva os dados do passo atual no perfil
         */
        function saveCurrentStepData() {
            const form = document.getElementById('current-step-form');
            if (!form) return;

            const formData = new FormData(form);
            const currentProfile = appState.profile;

            // Coleta dados simples
            for (const [key, value] of formData.entries()) {
                currentProfile[key] = value;
            }

            // Coleta dados complexos (Arrays)
            currentProfile.restrictions = formData.getAll('restrictions') || [];
            
            // Tratamento de campos de texto separados por v√≠rgula: avoidList, dispensa, costumo.
            const fieldsToProcess = ['avoidList', 'dispensa', 'costumo'];
            
            fieldsToProcess.forEach(field => {
                const formValue = formData.get(field);
                
                if (formValue !== null) {
                    // O campo foi enviado no formul√°rio. Processar a string.
                    currentProfile[field] = formValue.split(',')
                                                    .map(s => s.trim())
                                                    .filter(s => s.length > 0);
                } 
            });

            // Tratamento de checkboxes (useDispensa)
            currentProfile.useDispensa = document.getElementById('useDispensa') ? document.getElementById('useDispensa').checked : (currentProfile.useDispensa || false);

            appState.profile = currentProfile;
        }

        /**
         * Avan√ßa para o pr√≥ximo passo ou gera o plano
         */
        function nextStep() {
            saveCurrentStepData();

            // Valida√ß√£o simples
            const form = document.getElementById('current-step-form');
            if (form && !form.checkValidity()) {
                 showMessage("üî¥ Por favor, preencha todos os campos obrigat√≥rios.", true);
                 form.reportValidity(); // Mostra as mensagens de erro nativas do HTML
                 return;
            }

            showMessage("", false); // Limpa mensagens

            if (appState.currentStep < STEPS.length - 1) {
                appState.currentStep++;
                renderApp();
            } else {
                // √öltimo passo: Gerar Plano -> Chama a fun√ß√£o ass√≠ncrona
                generatePlanAsync(appState.profile);
            }
        }

        /**
         * Volta para o passo anterior
         */
        function prevStep() {
            appState.currentStep--;
            appState.isPlanGenerated = false;
            renderApp();
        }
        
        /**
         * Fun√ß√£o para ligar/desligar os campos de treino
         */
        function toggleTrainingFields(value) {
            const fields = document.getElementById('training-fields');
            if (fields) {
                fields.classList.toggle('hidden', value !== 'sim');
            }
        }

        /**
         * Fun√ß√£o para ligar/desligar os campos da dispensa
         */
        function toggleDispensaFields(isChecked) {
             const fields = document.getElementById('dispensa-fields');
            if (fields) {
                fields.classList.toggle('hidden', !isChecked);
            }
        }

        /**
         * Fun√ß√£o para mostrar a aba (Plano ou Lista de Compras)
         */
        function showTab(tabName) {
            document.getElementById('plan-content').classList.add('hidden');
            document.getElementById('shopping-content').classList.add('hidden');
            document.getElementById('tab-plan').classList.remove('tab-active');
            document.getElementById('tab-shopping').classList.remove('tab-active');

            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
        }


        /**
         * Renderiza o App Principal (chamado em cada transi√ß√£o)
         */
        function renderApp() {
            document.getElementById('message-area').classList.add('hidden');
            renderStepper();
            
            if (appState.isPlanGenerated) {
                renderPlanOutput();
            } else {
                renderFormStep();
            }
        }

        // Inicializa√ß√£o do App
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar favoritos e definir estado inicial
            appState.favorites = loadState('favorites') || [];

            // Tentar carregar perfil (se existir)
            const savedProfile = loadState('profile');
            if (savedProfile) {
                appState.profile = savedProfile;
                // Previne redefini√ß√£o de campos array se o estado for carregado.
            } else {
                 // Preenche valores padr√£o no perfil para evitar undefined em inputs
                 appState.profile = {
                    objective: 'perder_gordura', sex: 'masculino', age: 30, height: 175, weight: 80, numMeals: '4',
                    activity: 'moderado', training: 'nao', intensity: 'media', sleep: 'mais_6h',
                    style: 'indiferente', time: '15_30', budget: 'medio', hungerTime: 'none', // Adicionado hungerTime padr√£o
                    restrictions: [], avoidList: [], dispensa: [], costumo: [], useDispensa: false
                };
            }

            renderApp();
        });
    </script>
</body>
</html>
