<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FitPlan Pro ⚡</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c0f14;--card:#121722;--muted:#98a2b3;--text:#e6edf3;--brand:#17c964;--danger:#ff6b6b;--chip:#1b2332;
    --accent:#0ea5e9;--warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .container{max-width:1100px;margin:30px auto;padding:0 16px}
  .top{display:flex;gap:10px;align-items:center}
  .title{font-weight:800;font-size:28px}
  .steps{display:flex;gap:8px;margin:14px 0}
  .step{flex:1;text-align:center;padding:8px 0;border-radius:10px;background:#0f1420;color:#9aa6b2;border:1px solid #1b2230}
  .step.active{background:#0f1a2a;color:#d7e0ea;border-color:#2a3448}
  .card{background:var(--card);border:1px solid #20293c;border-radius:14px;padding:16px;margin-top:16px}
  h3{margin:8px 0 14px 0}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .input{grid-column:span 3}
  input,select{width:100%;background:#0f1420;border:1px solid #1e2637;color:var(--text);padding:10px;border-radius:10px;outline:none}
  .btn{background:#0f1420;border:1px solid #23304a;color:#dbe5f3;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#2e3f60}
  .btn.primary{background:#0e1f34;border-color:#0ea5e9}
  .btn.success{background:#0d2a1f;border-color:#177e5e;color:#bff1db}
  .btn.warn{background:#211b0b;border-color:#4f3d12;color:#ffe8bb}
  .btn.danger{background:#2c1313;border-color:#602828;color:#ffd7d7}
  .kpi{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .tag{background:var(--chip);padding:6px 10px;border-radius:999px;border:1px solid #27334a;color:#c8d3e0;font-size:12px}
  .good{color:#22c55e}.bad{color:#fb7185}.ok{color:#f59e0b}
  .tabs{display:flex;gap:10px;margin-top:6px}
  .tab{padding:8px 12px;border:1px solid #27334a;border-radius:10px;background:#0f1420;color:#c8d3e0;cursor:pointer}
  .tab.active{background:#112036;border-color:#2f466a}
  .meal{border:1px solid #22314a;border-radius:12px;margin-top:14px}
  .meal-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #22314a}
  .meal-bd{padding:8px 14px;display:flex;flex-direction:column;gap:8px}
  .food{display:grid;grid-template-columns:1fr 110px 56px 70px;gap:10px;align-items:center;border:1px dashed #2a3a58;border-radius:10px;padding:8px}
  .food small{color:#8ea1b6}
  .pin{width:30px;height:30px;border-radius:8px;border:1px solid #33496e;background:#0f1420;color:#9fb7d6;cursor:pointer}
  .muted{color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .hidden{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:5}
  .modal .box{background:var(--card);border:1px solid #26344f;border-radius:14px;max-width:720px;width:92%;padding:16px}
  .swap-list{max-height:360px;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .swap-item{display:flex;justify-content:space-between;align-items:center;border:1px solid #2a3d60;border-radius:10px;padding:8px}
  .list-simple{border:1px dashed #2c3e63;padding:12px;border-radius:10px}
  .center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="title">FitPlan Pro ⚡</div>
      <div class="muted">Gere sua dieta realista em <b>3 passos</b> — apenas <code>index.html</code> + <code>json</code>.</div>
    </div>

    <div class="steps">
      <div class="step active" id="s1">1</div>
      <div class="step" id="s2">2</div>
      <div class="step" id="s3">3</div>
    </div>

    <!-- Passo 1 -->
    <div class="card" id="step1">
      <h3>1) Seu Perfil</h3>
      <div class="row">
        <div class="input">
          <label>Sexo</label>
          <select id="sexo">
            <option>Masculino</option>
            <option>Feminino</option>
          </select>
        </div>
        <div class="input">
          <label>Idade (anos)</label>
          <input id="idade" type="number" min="14" max="90" value="33">
        </div>
        <div class="input">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="120" max="220" value="170">
        </div>
        <div class="input">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" value="69">
        </div>
        <div class="input" style="grid-column:span 4">
          <label>Atividade</label>
          <select id="ativ">
            <option value="1.2">Leve (1-2x/sem)</option>
            <option value="1.375" selected>Moderada (3–4x/sem)</option>
            <option value="1.55">Intensa (5–6x/sem)</option>
          </select>
        </div>
        <div class="input" style="grid-column:span 4">
          <label>Objetivo</label>
          <select id="obj">
            <option value="cut" selected>Secar (−15%)</option>
            <option value="keep">Manter (0%)</option>
            <option value="bulk">Ganhar (+12%)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button class="btn primary" id="calc">Calcular TDEE & Meta</button>
        <button class="btn" id="saveProfile">Salvar Perfil</button>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="kpi">
          <div class="tag">BMR (Mifflin): <b id="bmr">–</b></div>
          <div class="tag">TDEE: <b id="tdee">–</b></div>
          <div class="tag">Meta diária: <b id="kcalMeta">–</b></div>
          <div class="tag">Proteína é pesada <b>CRUA</b>; Carbo: <b>COZIDO</b>. Dica cardio Z2 ≈ <b id="bpm">–</b> bpm.</div>
        </div>
        <div style="margin-top:10px">
          <button class="btn success" id="go2">Próximo</button>
        </div>
      </div>
    </div>

    <!-- Passo 2 -->
    <div class="card hidden" id="step2">
      <h3>2) Escolha um modelo (presets elásticos)</h3>
      <div class="muted" style="margin-bottom:8px">
        Cada modelo é um estilo de montagem. Você pode trocar alimentos e gramaturas depois.
        Abaixo mostramos para quem cada modelo é indicado. O filtro respeita seu <b>Objetivo</b>.
      </div>
      <div id="presetsGrid" class="row" style="grid-template-columns:repeat(2,1fr)"></div>

      <div style="margin-top:10px">
        <button class="btn" id="back1">Voltar</button>
        <button class="btn success" id="go3">Próximo</button>
      </div>
    </div>

    <!-- Passo 3 -->
    <div class="card hidden" id="step3">
      <h3>3) Seu Plano</h3>
      <div class="muted">Fixe itens (<span class="ok">📌</span>) para não mudarem ao regerar. Proteína: <b>CRU</b> · Carbo: <b>COZIDO</b>.</div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="regenDay">Regerar dia</button>
        <button class="btn" id="favDay">Favoritar</button>
        <button class="btn" id="pngBtn">Exportar PNG</button>
        <button class="btn" id="pdfBtn">Exportar PDF</button>
        <button class="btn" id="saveJson">Salvar JSON</button>
        <button class="btn" id="importJson">Importar</button>
      </div>

      <div style="margin-top:12px" class="kpi">
        <div class="tag">Meta: <b id="metaK">–</b> kcal</div>
        <div class="tag">Total: <b id="totalK">–</b> kcal</div>
        <div class="tag" id="deltaTag">–</div>
        <div class="tag" id="macroTag">P:–g · C:–g · G:–g</div>
      </div>

      <div class="tabs" style="margin-top:12px">
        <div class="tab active" data-tab="planTab">Plano</div>
        <div class="tab" data-tab="listDayTab" id="listDayTabBtn" data-disabled="1" title="Gere um dia antes">Lista diária</div>
        <div class="tab" data-tab="listWeekTab">Lista semanal</div>
        <div class="tab" data-tab="favsTab">Favoritos</div>
      </div>

      <!-- Conteúdo das abas -->
      <div id="planTab"></div>
      <div id="listDayTab" class="hidden">
        <div class="list-simple" id="listDayBox"></div>
      </div>
      <div id="listWeekTab" class="hidden">
        <div class="grid2">
          <div class="muted">Gere 7 dias independentes (seeds novas, sem locks) e veja a lista de compras semanal.</div>
          <button class="btn" id="genWeek">Gerar semana…</button>
        </div>
        <div class="list-simple" id="weekListBox" style="margin-top:10px"></div>
      </div>
      <div id="favsTab" class="hidden">
        <div class="list-simple" id="favsBox">Sem favoritos ainda.</div>
      </div>

      <div style="margin-top:12px">
        <button class="btn" id="back2">Voltar</button>
        <button class="btn success" id="finish">Finalizar ↑</button>
      </div>
    </div>
  </div>

  <!-- Modal troca -->
  <div class="modal" id="swapModal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Trocar alimento</h3>
        <button class="btn" id="closeSwap">Fechar</button>
      </div>
      <div class="muted" id="swapHint">Equivalentes sugeridos…</div>
      <div class="swap-list" id="swapList"></div>
    </div>
  </div>

<!-- libs para exportação -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ===========================
   Estado global e utilidades
   =========================== */
const state = {
  profile: null,
  metaKcal: 0,
  seed: 0,
  preset: null,
  day: null,             // {meals:[{name, items:[{food, family, state, grams, kcal, P,C,G, locked}] }], totals}
  pools: null,           // { Proteina: {COZIDO:[...], ASSADO:[...]}, ... }
  foodsIndex: null,      // por nome
  manifest: null,
  presets: [],
  favs: [],
  week: null
};
const rand = (() => {
  let s=123456789; // inicial; será trocado a cada geração
  return {
    setSeed(n){ s = (n>>>0) || 1; },
    next(){ // LCG simples
      s = (1664525*s + 1013904223) >>> 0;
      return s / 2**32;
    },
    pick(arr){ return arr[Math.floor(rand.next()*arr.length)]; },
    shuffle(arr){ // Fisher-Yates
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rand.next()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
  }
})();

function newSeed(){
  const u = new Uint32Array(1);
  crypto.getRandomValues(u);
  return (u[0] ^ Date.now()) >>> 0;
}
function alertMsg(t){ window.alert(t); }

function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }
function sum(arr, k){ return arr.reduce((a,b)=>a+(k?b[k]:b),0); }

/* ===========================
   Carregamento dos dados
   =========================== */
async function loadAll(){
  const man = await fetch('data/foods_manifest.json').then(r=>r.json());
  const files = new Map(Object.entries(man.files||{}));
  const foods = {};
  for(const [family, path] of files){
    foods[family] = await fetch(`data/${path}`).then(r=>r.json());
  }
  const presets = await fetch('data/presets.json').then(r=>r.json());

  // index por nome
  const byName = {};
  for(const fam of Object.keys(foods)){
    for(const f of foods[fam]){
      byName[f.name] = {...f, family:fam};
    }
  }

  state.manifest = man;
  state.foodsIndex = byName;
  state.presets = presets;

  console.info('[load] manifest:', man);
  console.info('[load] presets:', presets.map(p=>p.name));
}

function buildPoolsFromManifest(){
  const pools = {};
  // construir por family -> state -> array
  for(const family of Object.keys(state.manifest.files)){
    pools[family] = {};
  }
  // distribuir
  for(const name of Object.keys(state.foodsIndex)){
    const f = state.foodsIndex[name];
    if(!pools[f.family]) pools[f.family] = {};
    if(!pools[f.family][f.state]) pools[f.family][f.state] = [];
    pools[f.family][f.state].push(f);
  }
  // fallback geral por família (all)
  for(const fam of Object.keys(pools)){
    const all = [];
    for(const st of Object.keys(pools[fam])){
      all.push(...pools[fam][st]);
    }
    pools[fam]._all = all;
  }
  state.pools = pools;
}

/* ===========================
   Perfil: BMR/TDEE/Meta
   =========================== */
function calcProfile(){
  const sexo = document.getElementById('sexo').value;
  const idade = +document.getElementById('idade').value;
  const altura = +document.getElementById('altura').value;
  const peso = +document.getElementById('peso').value;
  const ativ = +document.getElementById('ativ').value;
  const obj = document.getElementById('obj').value;

  const bmr = (sexo==='Masculino')
    ? (10*peso + 6.25*altura - 5*idade + 5)
    : (10*peso + 6.25*altura - 5*idade - 161);

  const tdee = bmr*ativ;
  const factor = (obj==='cut'?0.85 : obj==='bulk'?1.12 : 1);
  const meta = Math.round(tdee*factor);

  state.profile = {sexo,idade,altura,peso,ativ,obj,bmr,tdee,meta};

  document.getElementById('bmr').textContent = Math.round(bmr);
  document.getElementById('tdee').textContent = Math.round(tdee);
  document.getElementById('kcalMeta').textContent = meta;
  document.getElementById('bpm').textContent = Math.round(208-(0.7*idade));

  state.metaKcal = meta;
}

document.getElementById('calc').addEventListener('click', calcProfile);
document.getElementById('saveProfile').addEventListener('click', ()=>{
  if(!state.profile) calcProfile();
  localStorage.setItem('fitProfile', JSON.stringify(state.profile));
  alertMsg('Perfil salvo.');
});

/* ===========================
   Passo 2: Presets com filtro por objetivo
   =========================== */
function filterPresetsByGoal(){
  const goal = (state.profile?.obj)||document.getElementById('obj').value;
  const grid = document.getElementById('presetsGrid');
  grid.innerHTML='';
  const allowed = state.presets.filter(p=>{
    // regra: cut -> sem bulk; bulk -> sem cut/lowcarb; keep -> todos
    if(goal==='cut') return !/bulk/i.test(p.slug||p.name);
    if(goal==='bulk') return !/(cut|low[-\s]?carb)/i.test(p.slug||p.name);
    return true;
  });

  allowed.forEach(p=>{
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${p.name} (${p.meals.length})</div>
          <div class="muted" style="font-size:13px">${p.pitch||'Variedade elástica com trocas simples.'}</div>
          <div class="kpi" style="margin-top:6px">
            ${p.meals.map(m=>`<div class="tag">${m.name}</div>`).join('')}
          </div>
        </div>
        <div>
          <button class="btn success" data-preset="${p.slug||p.name}">Selecionar</button>
        </div>
      </div>`;
    grid.appendChild(el);
  });

  grid.querySelectorAll('[data-preset]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-preset');
      state.preset = state.presets.find(p=>(p.slug||p.name)===key);
      // dar um feedback
      btn.textContent = 'Selecionado ✓';
      setTimeout(()=>{ btn.textContent = 'Selecionar'; },900);
    });
  });
}

/* ===========================
   Solver de refeição e dia
   =========================== */
function kcalFromMacros(P,C,G){ return P*4 + C*4 + G*9; }

function solveMeal(mealSpec, kcalTarget){
  // mealSpec: {name, families:[{family, state?}], macro_ratio:{P,C,G}, portion_caps:{...}}
  // Construir tripé: proteína, carbo, gordura/misto – conforme families do preset
  // Estratégia: 1) escolha 1 alimento de cada família requerida; 2) estimativa de gramas; 3) clamp + redistribuição; 4) itera fallback se necessário
  const families = mealSpec.families || [];
  const caps = mealSpec.portion_caps || {min: {default: 30}, max: {default: 400}};
  const ratio = mealSpec.macro_ratio || {P:.3, C:.5, G:.2};

  function pickFood(fam, statePref){
    // estágio A: mesma familia e estado
    const poolA = (state.pools?.[fam]?.[statePref]) || [];
    if(poolA.length) return rand.pick(poolA);
    // estágio B: mesma família (qualquer estado)
    const poolB = (state.pools?.[fam]?._all)||[];
    if(poolB.length) return rand.pick(poolB);
    // fallback: se família “Misto” existe e refeição permite:
    if(state.pools?.Misto?._all?.length && fam!=='Misto'){
      return rand.pick(state.pools.Misto._all);
    }
    return null;
  }

  // 1) montar seleção base
  const items = [];
  for(const f of families){
    const food = pickFood(f.family, f.state);
    if(!food) return {ok:false, reason:`Sem candidatos para ${f.family}${f.state?`/${f.state}`:''}`};
    items.push({
      name: food.name, family: food.family, state: food.state,
      P100: food.P, C100: food.C, G100: food.G, kcal100: food.kcal
    });
  }

  // 2) estimativa inicial pelas macros alvo
  const targetP = (ratio.P||0)*kcalTarget/4;
  const targetC = (ratio.C||0)*kcalTarget/4;
  const targetG = (ratio.G||0)*kcalTarget/9;

  // dividir pelos itens aproximando por função:
  function gramsFor(item, gramP, gramC, gramG){
    // converter “g de macronutriente” em “g de alimento”, priorizando seu macro predominante
    const scores = [
      {k:'P100', want:gramP},
      {k:'C100', want:gramC},
      {k:'G100', want:gramG}
    ].sort((a,b)=>b.want - a.want);
    const key = scores[0].k;
    const want = scores[0].want;
    const per100 = item[key] || 0.0001;
    return (want/per100)*100;
  }

  // chute inicial proporcional
  const grams = [];
  for(const it of items){
    const g = gramsFor(it, targetP, targetC, targetG);
    grams.push(g);
  }

  // 3) clamp + correção
  function minCap(it){ return caps.min?.[it.family] ?? caps.min?.default ?? 20; }
  function maxCap(it){ return caps.max?.[it.family] ?? caps.max?.default ?? 500; }

  let iters = 0;
  while(iters++ < 3){
    // clamp
    for(let i=0;i<items.length;i++){
      grams[i] = clamp(grams[i], minCap(items[i]), maxCap(items[i]));
    }

    // medir resultado
    let P=0,C=0,G=0,K=0;
    for(let i=0;i<items.length;i++){
      const it = items[i], g = grams[i];
      const f = g/100;
      P += it.P100*f; C += it.C100*f; G += it.G100*f;
      K += it.kcal100*f;
    }
    const dK = kcalTarget - K;

    if(Math.abs(dK) <= Math.max(30, kcalTarget*0.03)){
      // sucesso
      const outItems = items.map((it,i)=>{
        const g = Math.round(grams[i]);
        const f = g/100;
        return {
          food: it.name, family: it.family, state: it.state, grams: g,
          P: +(it.P100*f).toFixed(1), C: +(it.C100*f).toFixed(1), G: +(it.G100*f).toFixed(1),
          kcal: Math.round(it.kcal100*f), locked:false
        }
      });
      return {ok:true, items: outItems};
    }

    // redistribuir: ajustar item com macro dominante mais próximo do sinal de dK
    // simples: mexe no item de maior kcal/100
    const idx = items
      .map((it,i)=>({i,kcal:it.kcal100}))
      .sort((a,b)=>b.kcal-a.kcal)[0].i;

    grams[idx] = clamp(grams[idx] + (dK>0?20:-20), minCap(items[idx]), maxCap(items[idx]));
  }

  return {ok:false, reason:'Solver não convergiu'};
}

function generateDay(){
  if(!state.preset){ alertMsg('Escolha um modelo no passo 2.'); return; }
  if(!state.profile) calcProfile();

  // nova seed e pools novos a cada geração
  state.seed = newSeed(); rand.setSeed(state.seed);
  buildPoolsFromManifest();

  const meta = state.profile.meta;
  const meals = [];
  let totalK=0, totalP=0, totalC=0, totalG=0;

  for(const m of state.preset.meals){
    const kcalTarget = Math.round(meta*(m.kcal_frac|| (1/state.preset.meals.length)));
    const solved = solveMeal(m, kcalTarget);
    if(!solved.ok){
      console.info('[meal solver fail]', m.name, solved.reason);
      alertMsg(`Erro ao regerar o dia. Motivo (refeição ${m.name}): ${solved.reason}.`);
      return;
    }
    meals.push({name:m.name, spec:m, items:solved.items});
    totalK += sum(solved.items,'kcal');
    totalP += sum(solved.items,'P');
    totalC += sum(solved.items,'C');
    totalG += sum(solved.items,'G');
  }

  state.day = {meals, total:{kcal:totalK,P:totalP,C:totalC,G:totalG}};
  renderPlan();
  enableListDay();
}

function regenMeal(idx){
  if(!state.day){ alertMsg('Gere um dia antes.'); return; }
  // manter locked daquela refeição
  const meal = state.day.meals[idx];
  const locked = meal.items.filter(x=>x.locked);
  const kcalTarget = sum(meal.items,'kcal');
  // seed nova
  state.seed = newSeed(); rand.setSeed(state.seed);
  buildPoolsFromManifest();

  const solved = solveMeal(meal.spec, kcalTarget);
  if(!solved.ok){
    alertMsg(`Erro ao regerar a refeição. Veja os dados dos alimentos no JSON. (${solved.reason})`);
    return;
  }
  // re-inserir itens locked (sobrepõe mesmo family)
  const map = new Map(solved.items.map(it=>[it.family, it]));
  for(const it of locked){ map.set(it.family, it); }
  const items = [...map.values()];

  meal.items = items;
  // recalc totais
  recalcTotals();
  renderPlan();
}

function recalcTotals(){
  let K=0,P=0,C=0,G=0;
  for(const m of state.day.meals){
    K += sum(m.items,'kcal');
    P += sum(m.items,'P');
    C += sum(m.items,'C');
    G += sum(m.items,'G');
  }
  state.day.total = {kcal:K,P,C,G};
}

/* ===========================
   Render do plano
   =========================== */
function renderPlan(){
  const plan = document.getElementById('planTab');
  const meta = state.profile.meta;
  const t = state.day.total;

  document.getElementById('metaK').textContent = meta;
  document.getElementById('totalK').textContent = t.kcal;
  const delta = Math.round(((t.kcal-meta)/meta)*100);
  const dEl = document.getElementById('deltaTag');
  if(Math.abs(delta)<=3){ dEl.innerHTML = `<span class="good">🟢 dentro do alvo (${delta>=0?'+':''}${delta}%)</span>`; }
  else if(delta<0){ dEl.innerHTML = `<span class="bad">🟠 abaixo (${delta}%)</span>`; }
  else{ dEl.innerHTML = `<span class="bad">🔴 acima (+${delta}%)</span>`; }
  document.getElementById('macroTag').textContent =
    `P:${Math.round(t.P)}g · C:${Math.round(t.C)}g · G:${Math.round(t.G)}g`;

  plan.innerHTML = '';
  state.day.meals.forEach((m,idx)=>{
    const head = document.createElement('div');
    head.className='meal';
    head.innerHTML = `
      <div class="meal-hd">
        <div>
          <b>${m.name}</b>
          <span class="muted" style="margin-left:6px">
            Alvo aprox.: P ${(m.spec.macro_ratio?.P*100||0).toFixed(0)}% · C ${(m.spec.macro_ratio?.C*100||0).toFixed(0)}% · G ${(m.spec.macro_ratio?.G*100||0).toFixed(0)}%
          </span>
        </div>
        <div class="kpi">
          <div class="tag">${sum(m.items,'kcal')} kcal</div>
          <button class="btn" data-rm="${idx}">Regerar refeição</button>
        </div>
      </div>
      <div class="meal-bd"></div>`;
    plan.appendChild(head);

    const bd = head.querySelector('.meal-bd');
    m.items.forEach((it,i)=>{
      const row = document.createElement('div'); row.className='food';
      row.innerHTML = `
        <div>
          <div><b>${it.food}</b></div>
          <small>Família: ${it.family} · Estado: ${it.state}</small>
        </div>
        <div class="muted">${it.grams} g</div>
        <div><button class="pin" title="Fixar" data-pin="${idx}:${i}">${it.locked?'📌':'📍'}</button></div>
        <div><button class="btn" data-swap="${idx}:${i}">Trocar</button></div>
      `;
      bd.appendChild(row);
    });
  });

  // eventos
  plan.querySelectorAll('[data-rm]').forEach(b=>{
    b.onclick = ()=> regenMeal(+b.getAttribute('data-rm'));
  });
  plan.querySelectorAll('[data-pin]').forEach(b=>{
    b.onclick = ()=>{
      const [mi,fi] = b.getAttribute('data-pin').split(':').map(Number);
      const it = state.day.meals[mi].items[fi];
      it.locked = !it.locked;
      b.textContent = it.locked ? '📌' : '📍';
    };
  });
  plan.querySelectorAll('[data-swap]').forEach(b=>{
    b.onclick = ()=> openSwap(b.getAttribute('data-swap'));
  });

  // lista diária
  renderListDay();
}

function enableListDay(){
  const tabBtn = document.getElementById('listDayTabBtn');
  tabBtn.dataset.disabled = '0';
  tabBtn.removeAttribute('title');
}

/* ===========================
   Troca de alimento (modal)
   =========================== */
const modal = document.getElementById('swapModal');
document.getElementById('closeSwap').onclick = ()=> modal.style.display='none';

function openSwap(key){
  const [mi,fi] = key.split(':').map(Number);
  const current = state.day.meals[mi].items[fi];
  const fam = current.family, st = current.state;

  const hint = document.getElementById('swapHint');
  hint.textContent = `Equivalentes para ${fam} (prioriza estado ${st}).`;

  // Estágio A
  const a = (state.pools?.[fam]?.[st])||[];
  // Estágio B
  const b = (state.pools?.[fam]?._all)||[];
  // Estágio C (se família Misto existir)
  const c = (state.pools?.Misto?._all)||[];

  const list = document.getElementById('swapList');
  list.innerHTML='';

  function addItem(food){
    const el = document.createElement('div');
    el.className='swap-item';
    el.innerHTML = `
      <div>
        <b>${food.name}</b>
        <div class="muted" style="font-size:12px">${food.family} · ${food.state} · P${food.P}/C${food.C}/G${food.G} · ${food.kcal} kcal/100g</div>
      </div>
      <button class="btn success">Usar</button>`;
    el.querySelector('button').onclick = ()=>{
      // mantém mesma gramatura aproximada e resolve só a refeição
      const grams = current.grams;
      state.day.meals[mi].items[fi] = {
        food: food.name, family: food.family, state: food.state, grams,
        P:+(food.P*grams/100).toFixed(1),
        C:+(food.C*grams/100).toFixed(1),
        G:+(food.G*grams/100).toFixed(1),
        kcal:Math.round(food.kcal*grams/100),
        locked:false
      };
      recalcTotals();
      renderPlan();
      modal.style.display='none';
    };
    list.appendChild(el);
  }

  const seen = new Set();
  function pushMany(arr){ arr.forEach(f=>{ if(!seen.has(f.name)) { seen.add(f.name); addItem(f); } }); }
  pushMany(rand.shuffle(a));
  pushMany(rand.shuffle(b));
  pushMany(rand.shuffle(c));

  if(!list.childElementCount){
    const d = document.createElement('div'); d.className='muted'; d.textContent='Sem equivalentes disponíveis.';
    list.appendChild(d);
  }
  modal.style.display='flex';
}

/* ===========================
   Abas: plano, lista diária, semana, favs
   =========================== */
function renderListDay(){
  if(!state.day) return;
  const box = document.getElementById('listDayBox');
  const map = new Map();
  for(const m of state.day.meals){
    for(const it of m.items){
      const k = it.food;
      map.set(k, (map.get(k)||0) + it.grams);
    }
  }
  box.innerHTML = [...map.entries()].map(([k,g])=>`${k} — <b>${Math.round(g)} g</b>`).join('<br>');
}

async function generateWeek(){
  if(!state.preset){ alertMsg('Escolha um modelo no passo 2.'); return; }
  const days = [];
  for(let d=0; d<7; d++){
    state.seed = newSeed(); rand.setSeed(state.seed);
    buildPoolsFromManifest();
    const meta = state.profile.meta;
    const meals = [];
    for(const m of state.preset.meals){
      const kcalTarget = Math.round(meta*(m.kcal_frac|| (1/state.preset.meals.length)));
      const solved = solveMeal(m, kcalTarget);
      if(!solved.ok){ alertMsg('Erro ao gerar lista semanal. Verifique os alimentos/presets.'); return; }
      meals.push({name:m.name, spec:m, items:solved.items});
    }
    days.push({meals});
  }
  state.week = days;

  // lista de compras semanal (soma)
  const box = document.getElementById('weekListBox');
  const agg = new Map();
  for(const d of days){
    for(const m of d.meals){
      for(const it of m.items){
        agg.set(it.food, (agg.get(it.food)||0) + it.grams);
      }
    }
  }
  box.innerHTML = [...agg.entries()].map(([k,g])=>`${k} — <b>${Math.round(g)} g</b>`).join('<br>');
}

/* ===========================
   Exportações
   =========================== */
document.getElementById('pngBtn').onclick = async ()=>{
  try{
    const el = document.getElementById('step3');
    const canvas = await html2canvas(el,{backgroundColor:'#0c0f14',scale:2});
    const link = document.createElement('a');
    link.download = `FitPlan_${new Date().toISOString().slice(0,10)}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }catch(e){ alertMsg('Falha ao gerar imagem'); console.error(e); }
};
document.getElementById('pdfBtn').onclick = async ()=>{
  try{
    const { jsPDF } = window.jspdf;
    const el = document.getElementById('step3');
    const canvas = await html2canvas(el,{backgroundColor:'#0c0f14',scale:2});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p','mm','a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = w*(canvas.height/canvas.width);
    pdf.addImage(img,'PNG',0,0,w,h);
    pdf.save(`FitPlan_${new Date().toISOString().slice(0,10)}.pdf`);
  }catch(e){ alertMsg('Falha ao gerar PDF'); console.error(e); }
};
document.getElementById('saveJson').onclick = ()=>{
  if(!state.day){ alertMsg('Gere um dia antes.'); return; }
  const data = {profile:state.profile, preset:(state.preset.slug||state.preset.name), day:state.day};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `fitplan_${Date.now()}.json`;
  a.click();
};
document.getElementById('importJson').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async ()=>{
    const file = inp.files[0]; if(!file) return;
    const data = JSON.parse(await file.text());
    state.profile = data.profile; state.preset = state.presets.find(p=>(p.slug||p.name)===data.preset) || state.presets[0];
    state.day = data.day; renderPlan(); enableListDay();
    // steps
    goStep(3);
  };
  inp.click();
};

/* ===========================
   Navegação / eventos
   =========================== */
function goStep(n){
  [1,2,3].forEach(i=>{
    document.getElementById(`step${i}`).classList.toggle('hidden', i!==n);
    document.getElementById(`s${i}`).classList.toggle('active', i===n);
  });
}
document.getElementById('go2').onclick = ()=>{ if(!state.profile) calcProfile(); filterPresetsByGoal(); goStep(2); };
document.getElementById('back1').onclick = ()=> goStep(1);
document.getElementById('go3').onclick = ()=>{
  if(!state.preset){ alertMsg('Selecione um modelo.'); return; }
  generateDay(); goStep(3);
};
document.getElementById('back2').onclick = ()=> goStep(2);
document.getElementById('finish').onclick = ()=> window.scrollTo({top:0,behavior:'smooth'});

document.getElementById('regenDay').onclick = ()=>{
  // opção: perguntar se mantém locks
  if(state.day){
    const keep = confirm('Manter itens fixos? (OK = mantém; Cancelar = libera tudo)');
    if(!keep){ for(const m of state.day.meals){ m.items.forEach(it=>it.locked=false); } }
  }
  generateDay();
};
document.getElementById('favDay').onclick = ()=>{
  if(!state.day){ alertMsg('Gere um dia antes.'); return; }
  state.favs.push(JSON.parse(JSON.stringify(state.day)));
  document.getElementById('favsBox').textContent = `Favoritos: ${state.favs.length} plano(s) salvos.`;
};
document.getElementById('genWeek').onclick = generateWeek;

// abas
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = ()=>{
    if(t.dataset.disabled==='1') return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.getAttribute('data-tab');
    ['planTab','listDayTab','listWeekTab','favsTab'].forEach(x=>{
      document.getElementById(x).classList.toggle('hidden', x!==id);
    });
  }
});

/* ===========================
   Boot
   =========================== */
(async function init(){
  await loadAll();
  const p = localStorage.getItem('fitProfile');
  if(p){ state.profile = JSON.parse(p); document.getElementById('sexo').value=state.profile.sexo; document.getElementById('idade').value=state.profile.idade; document.getElementById('altura').value=state.profile.altura; document.getElementById('peso').value=state.profile.peso; document.getElementById('ativ').value=state.profile.ativ; document.getElementById('obj').value=state.profile.obj; calcProfile(); }
})();
</script>
</body>
</html>
